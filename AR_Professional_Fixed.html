<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>DID AR Professional â€¢ ì‹¤ì œ ì œí’ˆ ì‚¬ì–‘ ê¸°ë°˜ AR ë°°ì¹˜</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#1a1a2e;overscroll-behavior:none;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR',sans-serif}
  canvas{position:fixed;inset:0;touch-action:none;opacity:0;transition:opacity 0.3s}
  canvas.ar-active{opacity:1}
  
  /* ===== ë””ë²„ê·¸ ì˜¤ë²„ë ˆì´ ===== */
  #debug{
    position:fixed;top:10px;left:10px;z-index:100;
    background:rgba(0,0,0,0.8);color:#0f0;padding:10px;
    border-radius:8px;font-family:monospace;font-size:11px;
    max-width:90vw;word-wrap:break-word;
  }
  
  /* ===== ì‹œì‘ í™”ë©´ ===== */
  #startScreen{
    position:fixed;inset:0;z-index:100;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:20px;
  }
  #startScreen.hidden{display:none}
  
  #startLogo{
    font-size:48px;margin-bottom:20px;
    animation:logoFloat 3s ease-in-out infinite;
  }
  @keyframes logoFloat{
    0%, 100%{transform:translateY(0px);}
    50%{transform:translateY(-10px);}
  }
  
  #startTitle{
    color:#fff;font-size:28px;font-weight:700;
    margin-bottom:12px;text-align:center;
    text-shadow:0 2px 10px rgba(0,0,0,0.3);
  }
  
  #startDesc{
    color:rgba(255,255,255,0.9);font-size:16px;
    margin-bottom:30px;text-align:center;max-width:400px;
    line-height:1.6;
  }
  
  #startBtnBig{
    background:#fff;color:#667eea;
    border:none;border-radius:50px;
    padding:18px 50px;font-size:18px;font-weight:700;
    cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.3);
    transition:all 0.3s;
  }
  #startBtnBig:hover{
    transform:translateY(-3px);
    box-shadow:0 12px 30px rgba(0,0,0,0.4);
  }
  #startBtnBig:active{transform:translateY(-1px)}
  
  #startFeatures{
    margin-top:40px;display:flex;flex-direction:column;gap:12px;
    max-width:400px;
  }
  .feature{
    display:flex;align-items:center;gap:12px;
    color:#fff;font-size:14px;
    background:rgba(255,255,255,0.1);
    padding:10px 16px;border-radius:10px;
    backdrop-filter:blur(10px);
  }
  .feature-icon{font-size:24px}
  
  /* ===== ìƒë‹¨ ì»¨íŠ¸ë¡¤ ===== */
  #topBar{
    position:fixed;top:0;left:0;right:0;z-index:20;
    background:linear-gradient(to bottom,rgba(0,0,0,.9),rgba(0,0,0,.7));
    padding:12px 14px;display:none;flex-direction:column;gap:9px;
    box-shadow:0 3px 15px rgba(0,0,0,.5);
  }
  .topRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;width:100%}
  
  /* ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
  .select-group{display:flex;align-items:center;gap:6px;color:#fff;font-size:13px}
  .select-group label{min-width:70px;font-weight:500}
  .select-group select{
    background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.35);
    border-radius:7px;padding:7px 11px;font-size:13px;min-width:130px;cursor:pointer;
    transition:all 0.2s;
  }
  .select-group select:hover{background:rgba(255,255,255,.28)}
  .select-group select:focus{outline:none;border-color:#4fc3ff;background:rgba(79,195,255,.25)}
  .select-group select option{background:#1a1a1a;color:#fff}
  
  .btn{
    color:#fff;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.3);
    border-radius:7px;padding:7px 13px;font-size:13px;cursor:pointer;
    white-space:nowrap;user-select:none;transition:all 0.2s;
  }
  .btn:active{background:rgba(255,255,255,.25);transform:scale(0.98)}
  .btn.active{background:rgba(0,150,255,.6);border-color:rgba(0,180,255,1);box-shadow:0 0 12px rgba(0,150,255,.5)}
  .btn.green{background:rgba(46,160,67,.7);border-color:rgba(46,160,67,1)}
  .btn.red{background:rgba(220,38,38,.7);border-color:rgba(220,38,38,1)}
  
  .group{display:flex;align-items:center;gap:6px;color:#fff;font-size:13px}
  input[type="range"]{width:90px;height:5px}
  input[type="checkbox"]{width:16px;height:16px}
  input[type="number"]{
    background:rgba(255,255,255,.18);color:#fff;border:1px solid rgba(255,255,255,.35);
    border-radius:6px;padding:6px 9px;font-size:13px;width:55px;
  }
  input[type="number"]:focus{outline:none;border-color:#4fc3ff}
  
  .divider{width:1px;height:22px;background:rgba(255,255,255,.25);margin:0 7px}
  
  /* ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width:480px){
    #topBar{padding:10px;gap:7px}
    .select-group select{min-width:110px;padding:6px 9px;font-size:12px}
    .btn{padding:6px 10px;font-size:12px}
    input[type="range"]{width:75px}
    .divider{display:none}
  }
  
  /* ===== í•˜ë‹¨ ì¸ë„¤ì¼ íŠ¸ë ˆì´ ===== */
  #bottomTray{
    position:fixed;left:0;right:0;bottom:0;z-index:21;
    background:rgba(0,0,0,.8);border-top:1px solid rgba(255,255,255,.2);
    padding:10px 12px;display:none;align-items:center;gap:10px;overflow-x:auto;
  }
  #thumbs{display:flex;gap:9px}
  .thumb{
    width:75px;height:45px;flex:0 0 auto;border-radius:7px;
    border:2px solid rgba(255,255,255,.3);overflow:hidden;cursor:pointer;transition:all 0.2s;
  }
  .thumb:hover{border-color:rgba(79,195,255,.7);transform:scale(1.05)}
  .thumb.active{border-color:#4fc3ff;box-shadow:0 0 0 2px rgba(79,195,255,.6) inset}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}

  
  /* ===== ë¦¬í‹°í´(ë°°ì¹˜ ê°€ì´ë“œ) ===== */
  #reticle{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:180px;height:180px;border:4px solid #4fc3ff;border-radius:50%;
    pointer-events:none;z-index:15;opacity:0;transition:opacity 0.3s;
    box-shadow:0 0 40px rgba(79,195,255,.8) inset, 0 0 30px rgba(79,195,255,.7);
    animation:reticlePulse 2s ease-in-out infinite;
  }
  @keyframes reticlePulse{
    0%, 100%{transform:translate(-50%,-50%) scale(1);opacity:1;}
    50%{transform:translate(-50%,-50%) scale(1.05);opacity:0.8;}
  }
  #reticle::before{
    content:'';position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:20px;height:20px;background:#4fc3ff;border-radius:50%;
    box-shadow:0 0 15px rgba(79,195,255,1);
  }
  #reticle::after{
    content:'ë°°ì¹˜ ìœ„ì¹˜';position:absolute;left:50%;bottom:-35px;transform:translateX(-50%);
    color:#4fc3ff;font-size:13px;font-weight:600;white-space:nowrap;
    text-shadow:0 2px 8px rgba(0,0,0,.8);transition:color 0.3s;
  }
  
  /* ===== FAB ë²„íŠ¼ë“¤ ===== */
  #fabContainer{
    position:fixed;right:14px;bottom:100px;z-index:22;
    display:flex;flex-direction:column;gap:11px;align-items:flex-end;
  }
  .fab{
    padding:13px 18px;border-radius:11px;font-weight:600;
    border:none;box-shadow:0 4px 16px rgba(0,0,0,.6);
    color:#fff;cursor:pointer;font-size:14px;
    min-width:105px;text-align:center;transition:all 0.2s;
  }
  #startBtn{background:#2ea043}
  #placeBtn{background:#0ea5e9;display:none}
  #captureBtn{background:#f59e0b;display:none}
  .fab:active{transform:scale(0.96)}
  .fab:hover{transform:translateY(-2px);box-shadow:0 6px 22px rgba(0,0,0,.7)}
  
  /* ===== í¸ì§‘ íŒ¨ë„ ===== */
  #editPanel{
    position:fixed;left:14px;bottom:100px;z-index:22;
    background:rgba(0,0,0,.92);border:1px solid rgba(255,255,255,.4);
    border-radius:11px;padding:13px;display:none;flex-direction:column;gap:11px;
    max-width:310px;box-shadow:0 4px 22px rgba(0,0,0,.7);
  }
  #editTitle{color:#4fc3ff;font-weight:600;font-size:14px;margin-bottom:3px}
  #editControls{display:flex;flex-direction:column;gap:9px}
  .editRow{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .editLabel{color:#fff;font-size:13px;min-width:55px}
  
  #dirPad{display:grid;grid-template-columns:38px 38px 38px;gap:4px;justify-self:center}
  #dirPad button{
    width:38px;height:38px;border-radius:6px;
    border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.15);
    color:#fff;font-size:16px;cursor:pointer;transition:all 0.15s;
  }
  #dirPad button:active{background:rgba(255,255,255,.35);transform:scale(0.95)}
  #dirPad .center{background:rgba(0,0,0,.3);width:30px;height:30px;margin:4px;opacity:0.4}
  #padUp{grid-column:2;grid-row:1}
  #padLeft{grid-column:1;grid-row:2}
  #padCenter{grid-column:2;grid-row:2}
  #padRight{grid-column:3;grid-row:2}
  #padDown{grid-column:2;grid-row:3}
  
  /* ===== í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ===== */
  #toast{
    position:fixed;left:50%;bottom:150px;transform:translateX(-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:9px 14px;
    border-radius:9px;z-index:40;display:none;font-size:13px;
    box-shadow:0 3px 12px rgba(0,0,0,.6);white-space:nowrap;
  }
  
  /* ===== ìº¡ì²˜ ì¸ë„¤ì¼ ìŠ¤íŠ¸ë¦½ ===== */
  #capStrip{
    position:fixed;left:10px;bottom:100px;z-index:21;
    display:flex;gap:7px;max-width:45vw;overflow-x:auto;
  }
  #capStrip img{
    width:70px;height:46px;border-radius:7px;border:1px solid rgba(255,255,255,.25);
    object-fit:cover;cursor:pointer;transition:all 0.2s;
  }
  #capStrip img:hover{border-color:rgba(79,195,255,.8);transform:scale(1.08)}
  
  /* ===== ìƒíƒœë°” ===== */
  #statusBar{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:12px 18px;
    border-radius:9px;z-index:19;font-size:14px;display:none;
    box-shadow:0 3px 15px rgba(0,0,0,.6);
  }
  
  /* ===== ì „ë©´ ì‚¬ì§„ ëª¨ë‹¬ ===== */

  
  /* WebXR ê¸°ë³¸ ë²„íŠ¼ ìˆ¨ê¹€ */
  [style*="z-index: 999"]{display:none !important;bottom:-9999px !important}
  
</style>
</head>
<body>

<!-- ì‹œì‘ í™”ë©´ -->
<div id="startScreen">
  <div id="startLogo">ğŸ“±âœ¨</div>
  <div id="startTitle">DID AR Professional</div>
  <div id="startDesc">
    ì¦ê°•í˜„ì‹¤ë¡œ ì‚¼ì„± DID ë””ìŠ¤í”Œë ˆì´ë¥¼ ì‹¤ì œ ê³µê°„ì— ë°°ì¹˜í•˜ê³ 
    ë‹¤ì–‘í•œ ì œí’ˆê³¼ ì„¤ì •ì„ ë¯¸ë¦¬ ì²´í—˜í•´ë³´ì„¸ìš”
  </div>
  <!-- ì „ë©´ ì‚¬ì§„ ì—…ë¡œë“œ (AR ì‹œì‘ ì „) -->
  <div style="margin:20px 0;padding:15px;background:rgba(255,255,255,0.1);border-radius:12px;max-width:400px;">
    <div style="color:#fff;font-size:14px;margin-bottom:10px;font-weight:500;">ğŸ“¸ ì „ë©´ ì‚¬ì§„ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)</div>
    <div style="color:rgba(255,255,255,0.7);font-size:12px;margin-bottom:12px;">DID ì œí’ˆì— í‘œì‹œí•  ì´ë¯¸ì§€ë‚˜ ë™ì˜ìƒì„ ë¯¸ë¦¬ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
    <input type="file" id="preARUpload" accept="image/*,video/*" multiple style="display:none;">
    <label for="preARUpload" style="display:inline-block;background:#fff;color:#667eea;padding:10px 20px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:600;">ì´ë¯¸ì§€/ë™ì˜ìƒ ì„ íƒ</label>
    <div id="preARStatus" style="color:#4fc3ff;font-size:12px;margin-top:10px;min-height:20px;"></div>
  </div>
  
  <button id="startBtnBig">ğŸš€ AR ì‹œì‘í•˜ê¸°</button>
  
  <div id="startFeatures">
    <div class="feature">
      <span class="feature-icon">ğŸ–¼ï¸</span>
      <span>ì‹¤ì œ ì œí’ˆ ì‚¬ì–‘ ê¸°ë°˜ ì •í™•í•œ í¬ê¸°</span>
    </div>
    <div class="feature">
      <span class="feature-icon">ğŸ¨</span>
      <span>ìƒ‰ìƒ, ë² ì ¤, í™”ë©´ ì´ë¯¸ì§€ ì»¤ìŠ¤í„°ë§ˆì´ì§•</span>
    </div>
    <div class="feature">
      <span class="feature-icon">ğŸ“¸</span>
      <span>AR ìŠ¤í¬ë¦°ìƒ· ì´¬ì˜ ë° ê³µìœ </span>
    </div>
  </div>
</div>

<!-- ë””ë²„ê·¸ ì˜¤ë²„ë ˆì´ -->
<div id="debug" style="display:none">ì´ˆê¸°í™” ì¤‘...</div>

<!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
<div id="topBar">
  <!-- 1í–‰: ì œí’ˆ ì„ íƒ -->
  <div class="topRow">
    <div class="select-group">
      <label>ğŸ–¼ï¸ ì¹´í…Œê³ ë¦¬</label>
      <select id="categorySelect">
        <option value="wall">ë²½ê±¸ì´í˜• DID</option>
        <option value="stand">ìŠ¤íƒ ë“œí˜• DID</option>
        <option value="videowall">ë¹„ë””ì˜¤ì›” (PB)</option>
      </select>
    </div>
    <div class="divider"></div>
    <div class="select-group">
      <label>ğŸ“ ëª¨ë¸</label>
      <select id="modelSelect">
        <!-- ë™ì  ìƒì„± -->
      </select>
    </div>
  </div>
  
  <!-- 2í–‰: ìƒ‰ìƒ / ë² ì ¤ / ë°ê¸° -->
  <div class="topRow">
    <button id="btnBlack" class="btn active">â¬› ë¸”ë™</button>
    <button id="btnWhite" class="btn">â¬œ í™”ì´íŠ¸</button>
    <div class="divider"></div>
    <div class="group">
      <input type="checkbox" id="showBezel" checked/>
      <label for="showBezel">ë² ì ¤ í‘œì‹œ</label>
    </div>
    <div class="divider"></div>
    <div class="group">
      ë°ê¸° <input id="brightnessRange" type="range" min="30" max="150" value="100"> <span id="brightnessVal">100%</span>
    </div>
  </div>
  
  <!-- 3í–‰: ë°°ì¹˜ ëª¨ë“œ / ì „ì²´ì‚­ì œ -->
  <div class="topRow">
    <div class="select-group">
      <label>ğŸ“ ë°°ì¹˜ìœ„ì¹˜</label>
      <select id="placeModeSelect">
        <option value="auto">ìë™ (ì œí’ˆ ìœ í˜•)</option>
        <option value="floor">ë°”ë‹¥</option>
        <option value="wall">ë²½ë©´</option>
      </select>
    </div>
    <div class="divider"></div>
    <button id="clearAll" class="btn red">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
  </div>
</div>

<!-- í•˜ë‹¨ ì¸ë„¤ì¼ íŠ¸ë ˆì´ -->
<div id="bottomTray">
  <div id="thumbs"></div>
</div>

<!-- ë¦¬í‹°í´ -->
<div id="reticle"></div>

<!-- ìƒíƒœë°” -->
<div id="statusBar">ë°”ë‹¥ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”</div>

<!-- FAB ë²„íŠ¼ë“¤ -->
<div id="fabContainer">
  <button id="startBtn" class="fab">ğŸš€ AR ì‹œì‘</button>
  <button id="placeBtn" class="fab">ğŸ“ ë°°ì¹˜í•˜ê¸°</button>
  <button id="captureBtn" class="fab">ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·</button>
</div>

<!-- í¸ì§‘ íŒ¨ë„ -->
<div id="editPanel">
  <div id="editTitle">ğŸ¯ ì„ íƒëœ ëª¨ë¸ ì¡°ì‘</div>
  <div id="editControls">
    <!-- ì´ë™ -->
    <div class="editRow">
      <span class="editLabel">ì´ë™</span>
      <div id="dirPad">
        <button id="padUp">â–²</button>
        <button id="padLeft">â—„</button>
        <div id="padCenter" class="center"></div>
        <button id="padRight">â–º</button>
        <button id="padDown">â–¼</button>
      </div>
    </div>
    <!-- íšŒì „ -->
    <div class="editRow">
      <span class="editLabel">íšŒì „</span>
      <button id="rotLeft" class="btn">âŸ² 15Â°</button>
      <button id="rotRight" class="btn">âŸ³ 15Â°</button>
      <button id="rotate90" class="btn" style="display:none">ğŸ”„ 90Â° (ì„¸ë¡œ/ê°€ë¡œ)</button>
    </div>
    <!-- ë†’ì´ ì¡°ì ˆ -->
    <div class="editRow">
      <span class="editLabel">ë†’ì´ ì¡°ì ˆ</span>
      <button id="heightUp" class="btn">â–²</button>
      <button id="heightDown" class="btn">â–¼</button>
      <span id="heightDisplay" style="color:#4fc3ff;font-weight:600">0mm</span>
    </div>
    <!-- ì•¡ì…˜ -->
    <div class="editRow" style="justify-content:space-between">
      <button id="deleteObj" class="btn red">ğŸ—‘ï¸ ì‚­ì œ</button>
      <button id="closeEdit" class="btn green">âœ“ ì™„ë£Œ</button>
    </div>
  </div>
</div>

<!-- ìº¡ì²˜ ì¸ë„¤ì¼ ìŠ¤íŠ¸ë¦½ -->
<div id="capStrip"></div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast">ì•Œë¦¼ ë©”ì‹œì§€</div>



<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

/* ========== ë””ë²„ê·¸ ë¡œê¹… ========== */
const debugEl = document.getElementById('debug');
function log(msg){
  console.log(msg);
  if(debugEl){
    debugEl.textContent = msg;
    debugEl.style.display = 'block';
    setTimeout(()=>{
      if(typeof renderer !== 'undefined' && renderer.xr && renderer.xr.isPresenting){
        debugEl.style.display = 'none';
      }
    }, 3000);
  }
}

/* ========== ê¸°ë³¸ ì„¸íŒ… ========== */
log('Three.js ì´ˆê¸°í™” ì¤‘...');

let renderer, scene, camera, dir;

try{
  renderer = new THREE.WebGLRenderer({
    antialias:true, 
    alpha:true, 
    preserveDrawingBuffer:true
  });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  document.body.appendChild(renderer.domElement);
  log('âœ“ Renderer ì´ˆê¸°í™” ì™„ë£Œ');
  
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 100);
  
  // ì¡°ëª… ì„¤ì •
  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x888888, 1.2);
  scene.add(hemiLight);
  
  dir = new THREE.DirectionalLight(0xffffff, 1.5);
  dir.position.set(0.5, 1, 0.3);
  scene.add(dir);
  
  // í™˜ê²½ê´‘ ì¶”ê°€
  const ambient = new THREE.AmbientLight(0xffffff, 0.5);
  scene.add(ambient);
  
  log('âœ“ Scene ì´ˆê¸°í™” ì™„ë£Œ');
}catch(e){
  log('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message);
  console.error('Init error:', e);
  alert('3D ë Œë”ë§ ì´ˆê¸°í™” ì‹¤íŒ¨. ë¸Œë¼ìš°ì €ë¥¼ ì¬ì‹œì‘í•´ì£¼ì„¸ìš”.');
  throw e;
}

/* ========== ì‹¤ì œ ì œí’ˆ ë°ì´í„° (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê¸°ë°˜) ========== */
const PRODUCT_DATA = {
  wall: {
    'LH43QHBE (43", 4K, 700nit)': {w:967.5,h:557.7,d:48.3,bezel:10,model:'LH43QHBE'},
    'LH43QMBE (43", 4K, 500nit)': {w:967.5,h:557.7,d:48.3,bezel:10,model:'LH43QMBE'},
    'LH50QHBE (50", 4K, 700nit)': {w:1121.4,h:643.9,d:46.3,bezel:10,model:'LH50QHBE'},
    'LH50QMBE (50", 4K, 500nit)': {w:1121.4,h:643.9,d:46.3,bezel:10,model:'LH50QMBE'},
    'LH75QHBE (75", 4K, 700nit)': {w:1681.1,h:960.1,d:49.7,bezel:12,model:'LH75QHBE'},
    'LH75QMBE (75", 4K, 500nit)': {w:1681.1,h:960.1,d:49.7,bezel:12,model:'LH75QMBE'},
    'LH85QBRB (85", 4K, 350nit)': {w:1897.8,h:1080.8,d:56.7,bezel:15,model:'LH85QBRB'},
    'LH85QMRB (85", 4K, 500nit)': {w:1897.8,h:1080.8,d:56.7,bezel:15,model:'LH85QMRB'},
  },
  stand: {
    '43QB430CSB (43", ìŠ¤íƒ ë“œ BASIC)': {w:585,h:1900,d:497.6,screenH:1350,screenW:585*0.85,bezel:15,model:'43QB430CSB'},
    '50QB500CSB (50", ìŠ¤íƒ ë“œ BASIC)': {w:691,h:1900,d:497.6,screenH:1350,screenW:691*0.85,bezel:15,model:'50QB500CSB'},
    '55QB550CSB (55", ìŠ¤íƒ ë“œ BASIC)': {w:740,h:1900,d:497.6,screenH:1350,screenW:740*0.85,bezel:15,model:'55QB550CSB'},
    '65QB650CSB (65", ìŠ¤íƒ ë“œ BASIC)': {w:900,h:1940,d:497.6,screenH:1380,screenW:900*0.85,bezel:18,model:'65QB650CSB'},
    '75QB750CSB (75", ìŠ¤íƒ ë“œ BASIC)': {w:1015,h:2090,d:560,screenH:1480,screenW:1015*0.85,bezel:20,model:'75QB750CSB'},
    '32QM320CSB (32", ìŠ¤íƒ ë“œ QM)': {w:470,h:1594.2,d:497.6,screenH:1100,screenW:470*0.85,bezel:12,model:'32QM320CSB'},
    '43QM430CSB (43", ìŠ¤íƒ ë“œ QM)': {w:585,h:1900,d:497.6,screenH:1350,screenW:585*0.85,bezel:15,model:'43QM430CSB'},
    '55QM550CSB (55", ìŠ¤íƒ ë“œ QM)': {w:740,h:1900,d:497.6,screenH:1350,screenW:740*0.85,bezel:15,model:'55QM550CSB'},
    '65QM650CSB (65", ìŠ¤íƒ ë“œ QM)': {w:900,h:1940,d:497.6,screenH:1380,screenW:900*0.85,bezel:18,model:'65QM650CSB'},
  },
  videowall: {
    'VW550E-5 (55", 2.6mm, 500nit)': {w:1212.2,h:683,d:92.5,bezel:2.6,model:'VW550E-5'},
    'VW550E-7 (55", 2.6mm, 700nit)': {w:1212.2,h:683,d:92.5,bezel:2.6,model:'VW550E-7'},
    'VW550R-5 (55", 0.88mm, 500nit)': {w:1210.51,h:681.22,d:92.4,bezel:0.88,model:'VW550R-5'},
    'VW550R-7 (55", 0.88mm, 700nit)': {w:1210.51,h:681.22,d:92.4,bezel:0.88,model:'VW550R-7'},
  }
};

/* ========== ìƒíƒœ ê´€ë¦¬ ========== */
let placed=[], selectedObj=null;
let currentCategory='wall', currentModel=null;
let bodyColor='black', showBezel=true, brightness=1.0;
let currentScreenTexture=null;
let heightOffset=0; // mm ë‹¨ìœ„
let isTwoFinger=false, pinchStartYaw=0, twistStartAngle=0;
let placeMode='auto'; // 'auto', 'floor', 'wall'

/* ========== ì¬ì§ˆ ========== */
const loader = new THREE.TextureLoader();
let bodyMat = new THREE.MeshStandardMaterial({
  color:0x111111, roughness:0.5, metalness:0.4,
  emissive:0x000000, emissiveIntensity:0
});

function newScreenMat(){
  return new THREE.MeshStandardMaterial({
    map:currentScreenTexture, 
    roughness:0.15,
    metalness:0.05,
    emissive:0x000000,
    emissiveIntensity:0.0,
    envMapIntensity:0.5
  });
}
function newFrontMat(){
  return new THREE.MeshBasicMaterial({
    map:currentFrontTexture, transparent:true, opacity:1.0
  });
}

function newGlassMat(){
  return new THREE.MeshPhysicalMaterial({
    color:0xf5f5f5,
    metalness:0.0,
    roughness:0.08,
    transparent:true,
    opacity:0.08,
    reflectivity:0.7,
    clearcoat:0.8,
    clearcoatRoughness:0.1,
    envMapIntensity:1.0
  });
}

/* ========== 3D ëª¨ë¸ ìƒì„± ========== */
function makeWallModel(spec){
  const W=spec.w/1000, H=spec.h/1000, D=spec.d/1000;
  const BZ=spec.bezel/1000;
  
  const group = new THREE.Group();
  group.userData.type='wall';
  group.userData.spec=spec;
  
  // ë³¸ì²´
  const body = new THREE.Mesh(new THREE.BoxGeometry(W,H,D), bodyMat);
  body.position.y=H/2;
  body.userData.isBody=true;
  group.add(body);
  
  // ë² ì ¤
  if(showBezel){
    const bezelMat = new THREE.MeshStandardMaterial({
      color:bodyColor==='black'?0x2a2a2a:0xfafafa,
      roughness:0.25,
      metalness:0.6,
      clearcoat:0.3,
      clearcoatRoughness:0.4
    });
    const bezelGeo = new THREE.BoxGeometry(W-BZ*2, H-BZ*2, 0.002);
    const bezel = new THREE.Mesh(bezelGeo, bezelMat);
    bezel.position.set(0,H/2,D/2+0.001);
    group.add(bezel);
  }
  
  // ìŠ¤í¬ë¦°
  const screenW=W-BZ*2-0.01, screenH=H-BZ*2-0.01;
  const screen = new THREE.Mesh(new THREE.PlaneGeometry(screenW, screenH), newScreenMat());
  screen.position.set(0,H/2,D/2+0.003);
  screen.userData.isScreen=true;
  group.add(screen);
  group.userData.screenMesh=screen;
  
  // ìœ ë¦¬ ë³´í˜¸ë§‰
  const glass = new THREE.Mesh(new THREE.PlaneGeometry(screenW, screenH), newGlassMat());
  glass.position.set(0,H/2,D/2+0.004);
  group.add(glass);
  
  // ì „ë©´ ì‚¬ì§„
  if(currentFrontTexture){
    const front = new THREE.Mesh(new THREE.PlaneGeometry(screenW*0.98, screenH*0.98), newFrontMat());
    front.position.set(0,H/2,D/2+0.006);
    group.add(front);
    group.userData.frontMesh=front;
  }
  
  return group;
}

function makeStandModel(spec){
  const W=spec.w/1000, H=spec.h/1000, D=spec.d/1000;
  const BZ=spec.bezel/1000;
  const baseH=0.05, baseW=W*1.2, baseD=D;
  
  const group = new THREE.Group();
  group.userData.type='stand';
  group.userData.spec=spec;
  
  // ë² ì´ìŠ¤
  const base = new THREE.Mesh(new THREE.BoxGeometry(baseW,baseH,baseD), bodyMat);
  base.position.y=baseH/2;
  base.userData.isBody=true;
  group.add(base);
  
  // ëª¸í†µ
  const bodyH=H-baseH;
  const body = new THREE.Mesh(new THREE.BoxGeometry(W,bodyH,D/4), bodyMat);
  body.position.y=baseH+bodyH/2;
  body.userData.isBody=true;
  group.add(body);
  
  // ìŠ¤í¬ë¦° ìœ„ì¹˜
  const screenW=spec.screenW/1000-BZ*2-0.01;
  const screenH=spec.screenH/1000-BZ*2-0.01;
  const screenCenterY = H - (screenH/2) - 0.1;
  
  // ë² ì ¤
  if(showBezel){
    const bezelMat = new THREE.MeshStandardMaterial({
      color:bodyColor==='black'?0x2a2a2a:0xfafafa,
      roughness:0.25,
      metalness:0.6,
      clearcoat:0.3,
      clearcoatRoughness:0.4
    });
    const bW=spec.screenW/1000-BZ*2, bH=spec.screenH/1000-BZ*2;
    const bezel = new THREE.Mesh(new THREE.BoxGeometry(bW,bH,0.002), bezelMat);
    bezel.position.set(0, screenCenterY, D/8+0.001);
    group.add(bezel);
  }
  
  // ìŠ¤í¬ë¦°
  const screen = new THREE.Mesh(new THREE.PlaneGeometry(screenW, screenH), newScreenMat());
  screen.position.set(0, screenCenterY, D/8+0.003);
  screen.userData.isScreen=true;
  group.add(screen);
  group.userData.screenMesh=screen;
  
  // ìœ ë¦¬ ë³´í˜¸ë§‰
  const glass = new THREE.Mesh(new THREE.PlaneGeometry(screenW, screenH), newGlassMat());
  glass.position.set(0, screenCenterY, D/8+0.004);
  group.add(glass);
  
  // ì „ë©´ ì‚¬ì§„
  if(currentFrontTexture){
    const front = new THREE.Mesh(new THREE.PlaneGeometry(screenW*0.98, screenH*0.98), newFrontMat());
    front.position.set(0, screenCenterY, D/8+0.006);
    group.add(front);
    group.userData.frontMesh=front;
  }
  
  return group;
}

function makeVideowallModel(spec){
  const W=spec.w/1000, H=spec.h/1000, D=spec.d/1000;
  const BZ=spec.bezel/1000;
  
  const group = new THREE.Group();
  group.userData.type='videowall';
  group.userData.spec=spec;
  
  // ë³¸ì²´
  const body = new THREE.Mesh(new THREE.BoxGeometry(W,H,D), bodyMat);
  body.position.y=H/2;
  body.userData.isBody=true;
  group.add(body);
  
  // ë² ì ¤
  if(showBezel && BZ>0.001){
    const bezelMat = new THREE.MeshStandardMaterial({
      color:0x2a2a2a, 
      roughness:0.2,
      metalness:0.8,
      clearcoat:0.5,
      clearcoatRoughness:0.3
    });
    const bezelGeo = new THREE.BoxGeometry(W-BZ*2, H-BZ*2, 0.001);
    const bezel = new THREE.Mesh(bezelGeo, bezelMat);
    bezel.position.set(0,H/2,D/2+0.0005);
    group.add(bezel);
  }
  
  // ìŠ¤í¬ë¦°
  const screenW=W-BZ*2-0.005, screenH=H-BZ*2-0.005;
  const screen = new THREE.Mesh(new THREE.PlaneGeometry(screenW, screenH), newScreenMat());
  screen.position.set(0,H/2,D/2+0.002);
  screen.userData.isScreen=true;
  group.add(screen);
  group.userData.screenMesh=screen;
  
  // ìœ ë¦¬ ë³´í˜¸ë§‰
  const glass = new THREE.Mesh(new THREE.PlaneGeometry(screenW, screenH), newGlassMat());
  glass.position.set(0,H/2,D/2+0.0025);
  group.add(glass);
  
  // ì „ë©´ ì‚¬ì§„
  if(currentFrontTexture){
    const front = new THREE.Mesh(new THREE.PlaneGeometry(screenW*0.98, screenH*0.98), newFrontMat());
    front.position.set(0,H/2,D/2+0.005);
    group.add(front);
    group.userData.frontMesh=front;
  }
  
  return group;
}

function createModel(){
  if(!currentModel) return null;
  const cat = currentCategory;
  const spec = PRODUCT_DATA[cat][currentModel];
  if(!spec) return null;
  
  if(cat==='wall') return makeWallModel(spec);
  if(cat==='stand') return makeStandModel(spec);
  if(cat==='videowall') return makeVideowallModel(spec);
  return null;
}

/* ========== UI ì´ˆê¸°í™” ========== */
const $=id=>document.getElementById(id);
const categorySelect=$('categorySelect'), modelSelect=$('modelSelect');

function updateModelList(){
  modelSelect.innerHTML='';
  const models = Object.keys(PRODUCT_DATA[currentCategory]);
  models.forEach((m,i)=>{
    const opt=document.createElement('option');
    opt.value=m; opt.textContent=m;
    modelSelect.appendChild(opt);
    if(i===0) currentModel=m;
  });
  modelSelect.value=currentModel||models[0];
}

categorySelect.onchange=()=>{currentCategory=categorySelect.value; updateModelList();};
modelSelect.onchange=()=>{currentModel=modelSelect.value;};

updateModelList();

// ë°°ì¹˜ ëª¨ë“œ ì„ íƒ
const placeModeSelect=$('placeModeSelect');
placeModeSelect.onchange=()=>{
  placeMode=placeModeSelect.value;
  log(`ë°°ì¹˜ ëª¨ë“œ ë³€ê²½: ${placeMode}`);
};

// ìƒ‰ìƒ
$('btnBlack').onclick=()=>{
  bodyColor='black'; bodyMat.color.set(0x111111);
  $('btnBlack').classList.add('active'); $('btnWhite').classList.remove('active');
};
$('btnWhite').onclick=()=>{
  bodyColor='white'; bodyMat.color.set(0xf2f2f2);
  $('btnWhite').classList.add('active'); $('btnBlack').classList.remove('active');
};

// ë² ì ¤ í† ê¸€
$('showBezel').onchange=()=>{showBezel=$('showBezel').checked;};

// ë°ê¸°
$('brightnessRange').oninput=()=>{
  brightness=parseInt($('brightnessRange').value,10)/100;
  $('brightnessVal').textContent=$('brightnessRange').value+'%';
  dir.intensity = brightness;
};



// ì „ì²´ì‚­ì œ
$('clearAll').onclick=()=>{
  placed.forEach(o=>scene.remove(o));
  placed.length=0; selectedObj=null;
  $('editPanel').style.display='none';
  showToast('ëª¨ë¸ ì „ì²´ ì‚­ì œë¨');
};

/* ========== ì¸ë„¤ì¼ ê´€ë¦¬ ========== */
function addScreenThumbnail(url, active=false){
  const div=document.createElement('div'); div.className='thumb';
  const img=document.createElement('img'); img.src=url; div.appendChild(img);
  div.onclick=()=>{
    document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));
    div.classList.add('active');
    
    const tex=loader.load(url);
    tex.colorSpace=THREE.SRGBColorSpace;
    currentScreenTexture=tex;
    showToast('âœ“ í™”ë©´ ì´ë¯¸ì§€ ì ìš©ë¨');
  };
  $('thumbs').appendChild(div);
  if(active) div.click();
}

// ê¸°ë³¸ ì´ë¯¸ì§€ ì¶”ê°€
addScreenThumbnail('https://picsum.photos/800/450?random=1',true);
addScreenThumbnail('https://picsum.photos/800/450?random=2',false);



/* ========== ì „ë©´ ì‚¬ì§„ ì—…ë¡œë“œ (AR ì‹œì‘ ì „) ========== */
const preARUpload = $('preARUpload');
const preARStatus = $('preARStatus');
let preUploadedFiles = []; // ë¯¸ë¦¬ ì—…ë¡œë“œí•œ íŒŒì¼ë“¤

preARUpload.onchange = (e) => {
  const files = Array.from(e.target.files || []);
  if(!files.length) return;
  
  preUploadedFiles = [];
  preARStatus.textContent = `${files.length}ê°œ íŒŒì¼ ì—…ë¡œë“œë¨ âœ“`;
  
  files.forEach(f => {
    const url = URL.createObjectURL(f);
    preUploadedFiles.push({
      url: url,
      name: f.name,
      type: f.type
    });
    
    // í™”ë©´ ì´ë¯¸ì§€ ì¸ë„¤ì¼ì— ì¶”ê°€
    if(f.type.startsWith('image/')){
      // ì‹œì‘ í›„ ì¸ë„¤ì¼ íŠ¸ë ˆì´ì— ìë™ ì¶”ê°€ë¨
    }
  });
  
  log(`Pre-AR ì—…ë¡œë“œ: ${files.length}ê°œ íŒŒì¼`);
};





/* ========== XR Hit-test ========== */
let hitSource=null, transientSource=null, requested=false;
let lastHitPose=null, lastHitType='floor'; // 'floor' or 'wall'

// í‰ë©´ì´ ë²½ì¸ì§€ ë°”ë‹¥ì¸ì§€ íŒë‹¨
function isWallPlane(pose){
  // poseì˜ ë³€í™˜ í–‰ë ¬ì—ì„œ ë²•ì„  ë²¡í„° ì¶”ì¶œ
  const matrix = new THREE.Matrix4().fromArray(pose.transform.matrix);
  const normal = new THREE.Vector3(0, 0, 1).applyMatrix4(matrix).normalize();
  
  // Yì¶• ì„±ë¶„ì´ ì‘ìœ¼ë©´ ë²½ (ìˆ˜ì§ í‰ë©´)
  // Yì¶• ì„±ë¶„ì´ í¬ë©´ ë°”ë‹¥/ì²œì¥ (ìˆ˜í‰ í‰ë©´)
  const verticalComponent = Math.abs(normal.y);
  return verticalComponent < 0.5; // 45ë„ ì´ìƒ ê¸°ìš¸ì–´ì§€ë©´ ë²½ìœ¼ë¡œ íŒë‹¨
}

renderer.setAnimationLoop((_,frame)=>{
  if(frame){
    const ref=renderer.xr.getReferenceSpace();
    const session=renderer.xr.getSession();
    if(!requested && session){
      log('Hit-test ì´ˆê¸°í™” ì¤‘...');
      session.requestReferenceSpace('viewer').then(view=>{
        session.requestHitTestSource({space:view})
          .then(src=>{
            hitSource=src;
            log('âœ“ Hit-test ì¤€ë¹„ ì™„ë£Œ (ë²½/ë°”ë‹¥ ëª¨ë‘ ê°ì§€)');
          })
          .catch(err=>{
            log('âŒ Hit-test ì‹¤íŒ¨: '+err.message);
          });
      }).catch(err=>{
        log('âŒ Viewer space ì‹¤íŒ¨: '+err.message);
      });
      
      session.requestHitTestSourceForTransientInput({profile:'generic-touchscreen'})
        .then(src=>transientSource=src).catch(()=>{});
      
      session.addEventListener('end',()=>{
        requested=false; hitSource=null; transientSource=null;
        // Canvas ìˆ¨ê¸°ê¸°
        renderer.domElement.classList.remove('ar-active');
        // ì‹œì‘ í™”ë©´ ë‹¤ì‹œ í‘œì‹œ
        startScreen.classList.remove('hidden');
        // UI ìˆ¨ê¸°ê¸°
        $('topBar').style.display='none';
        $('bottomTray').style.display='none';
        $('startBtn').style.display='block';
        $('placeBtn').style.display='none';
        $('captureBtn').style.display='none';
        $('reticle').style.opacity='0';
        $('statusBar').style.display='none';
        log('AR ì„¸ì…˜ ì¢…ë£Œë¨');
      });
      requested=true;
    }
    if(hitSource){
      const hits=frame.getHitTestResults(hitSource);
      
      // ë°°ì¹˜ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ í‰ë©´ ì°¾ê¸°
      let validHit = null;
      let validType = null;
      
      for(const hit of hits){
        const pose = hit.getPose(ref);
        if(!pose) continue;
        
        const isWall = isWallPlane(pose);
        
        // ëª¨ë“œì— ë”°ë¼ í•„í„°ë§
        if(placeMode === 'auto'){
          // ìë™: ì œí’ˆ íƒ€ì…ì— ë”°ë¼
          if(currentCategory === 'wall' || currentCategory === 'videowall'){
            // ë²½ê±¸ì´í˜• â†’ ë²½ ì„ í˜¸
            if(isWall){ validHit=pose; validType='wall'; break; }
            if(!validHit){ validHit=pose; validType='floor'; } // fallback
          }else{
            // ìŠ¤íƒ ë“œí˜• â†’ ë°”ë‹¥ ì„ í˜¸
            if(!isWall){ validHit=pose; validType='floor'; break; }
            if(!validHit){ validHit=pose; validType='wall'; } // fallback
          }
        }else if(placeMode === 'wall'){
          // ë²½ ëª¨ë“œ: ë²½ë§Œ
          if(isWall){ validHit=pose; validType='wall'; break; }
        }else if(placeMode === 'floor'){
          // ë°”ë‹¥ ëª¨ë“œ: ë°”ë‹¥ë§Œ
          if(!isWall){ validHit=pose; validType='floor'; break; }
        }
      }
      
      if(validHit){
        lastHitPose=validHit;
        lastHitType=validType;
        $('reticle').style.opacity='1';
        $('statusBar').style.display='none';
        
        // ë¦¬í‹°í´ ìƒ‰ìƒ ë³€ê²½ (ë²½=íŒŒë‘, ë°”ë‹¥=ì´ˆë¡)
        const reticle = $('reticle');
        if(validType === 'wall'){
          reticle.style.borderColor='#4fc3ff';
          reticle.style.boxShadow='0 0 40px rgba(79,195,255,.8) inset, 0 0 30px rgba(79,195,255,.7)';
        }else{
          reticle.style.borderColor='#2ea043';
          reticle.style.boxShadow='0 0 40px rgba(46,160,67,.8) inset, 0 0 30px rgba(46,160,67,.7)';
        }
      }else{
        lastHitPose=null;
        $('reticle').style.opacity='0';
        $('statusBar').style.display='block';
        $('statusBar').textContent = placeMode==='wall' ? 'ë²½ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”' : 'ë°”ë‹¥ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”';
      }
    }
    if(selectedObj && isTwoFinger && transientSource){
      const thits = frame.getHitTestResultsForTransientInput(transientSource);
      if(thits.length && thits[0].results.length){
        const pose = thits[0].results[0].getPose(ref);
        const py=selectedObj.userData._planeY??pose.transform.position.y;
        selectedObj.position.set(
          pose.transform.position.x,
          py+(heightOffset/1000),
          pose.transform.position.z
        );
      }
    }
  }
  renderer.render(scene,camera);
});

/* ========== ë°°ì¹˜ ========== */
function placeModel(){
  if(!lastHitPose){
    showToast(lastHitType==='wall'?'ë²½ì„ ì¸ì‹í•´ì£¼ì„¸ìš”':'ë°”ë‹¥ì„ ì¸ì‹í•´ì£¼ì„¸ìš”'); 
    return;
  }
  const model=createModel();
  if(!model){showToast('ëª¨ë¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”'); return;}
  
  const m=new THREE.Matrix4().fromArray(lastHitPose.transform.matrix);
  const pos=new THREE.Vector3().setFromMatrixPosition(m);
  const quat=new THREE.Quaternion().setFromRotationMatrix(m);
  
  model.position.copy(pos);
  
  // ë²½ë©´ ë°°ì¹˜ì˜ ê²½ìš° íšŒì „ ì¡°ì •
  if(lastHitType === 'wall'){
    // ë²½ë©´ ë²•ì„  ë²¡í„° ì¶”ì¶œ
    const normal = new THREE.Vector3(0, 0, 1).applyMatrix4(m).normalize();
    
    // ë²½ê±¸ì´í˜•ì´ë©´ ë²½ì— ìˆ˜ì§ìœ¼ë¡œ ë°°ì¹˜
    if(currentCategory === 'wall' || currentCategory === 'videowall'){
      // ë²½ì„ í–¥í•˜ë„ë¡ íšŒì „
      const angle = Math.atan2(normal.x, normal.z);
      model.rotation.y = angle + Math.PI; // ë²½ì„ í–¥í•˜ë„ë¡
      
      // ë²½ì— ë¶™ì´ê¸° (ì•½ê°„ ì•ìœ¼ë¡œ)
      const offset = 0.05; // 5cm ì•ìœ¼ë¡œ
      model.position.x += normal.x * offset;
      model.position.z += normal.z * offset;
    }
    
    model.userData._isWallMounted = true;
    showToast('ë²½ë©´ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤');
  }else{
    // ë°”ë‹¥ ë°°ì¹˜
    model.position.y += (heightOffset/1000);
    model.quaternion.copy(quat);
    model.userData._isWallMounted = false;
    showToast('ë°”ë‹¥ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤');
  }
  
  model.userData._planePos=pos.clone();
  model.userData._planeType=lastHitType;
  
  scene.add(model);
  placed.push(model);
  
  setTimeout(()=>{
    selectedObj=model;
    showEditPanel();
    log(`âœ“ ëª¨ë¸ ë°°ì¹˜ë¨: ${placed.length}ê°œ (${lastHitType})`);
  },100);
}

/* ========== ì„ íƒ ========== */
const raycaster = new THREE.Raycaster();
const canvas=renderer.domElement;
const tapMaxMs=220, tapMaxMove=10;
let tapStart={t:0,x:0,y:0};

function selectByTap(clientX,clientY){
  const x=(clientX/window.innerWidth)*2-1;
  const y=-(clientY/window.innerHeight)*2+1;
  raycaster.setFromCamera({x,y},camera);
  
  const meshes=[];
  placed.forEach(g=>g.traverse(o=>{if(o.isMesh && o.userData.isBody) meshes.push(o);}));
  const hits=raycaster.intersectObjects(meshes,true);
  if(hits.length){
    let p=hits[0].object;
    while(p && !placed.includes(p)) p=p.parent;
    if(p){
      if(selectedObj===p){ selectedObj=null; hideEditPanel(); showToast('ì„ íƒ í•´ì œë¨'); return true; }
      selectedObj=p;
      showEditPanel();
      showToast('ëª¨ë¸ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤');
      return true;
    }
  }
  return false;
}

canvas.addEventListener('touchstart',ev=>{
  const t=ev.touches[0];
  tapStart={t:performance.now(),x:t.clientX,y:t.clientY};
  if(ev.touches.length===2){
    isTwoFinger=true;
    const a=ev.touches[0],b=ev.touches[1];
    twistStartAngle=Math.atan2(b.clientY-a.clientY,b.clientX-a.clientX);
    pinchStartYaw=selectedObj?selectedObj.rotation.y:0;
    if(!selectedObj && placed.length){
      let min=1e9, pick=null;
      placed.forEach(o=>{
        const d=camera.position.distanceTo(o.position);
        if(d<min){min=d; pick=o;}
      });
      if(pick && min<2.5){selectedObj=pick; showEditPanel();}
    }
  }
},{passive:true});

canvas.addEventListener('touchmove',ev=>{
  if(!isTwoFinger || ev.touches.length!==2) return;
  const a=ev.touches[0],b=ev.touches[1];
  const curAng=Math.atan2(b.clientY-a.clientY,b.clientX-a.clientX);
  if(selectedObj) selectedObj.rotation.y=pinchStartYaw+(curAng-twistStartAngle);
},{passive:true});

canvas.addEventListener('touchend',ev=>{
  const now=performance.now();
  const dt=now-tapStart.t;
  let moved=0;
  if(ev.changedTouches && ev.changedTouches[0]){
    moved=Math.hypot(ev.changedTouches[0].clientX-tapStart.x, ev.changedTouches[0].clientY-tapStart.y);
  }
  if(ev.touches.length===0){
    if(!isTwoFinger){
      if(dt<=tapMaxMs && moved<=tapMaxMove){
        const ct=ev.changedTouches[0];
        selectByTap(ct.clientX, ct.clientY);
      }
    }
    isTwoFinger=false;
  }else if(ev.touches.length===1){
    isTwoFinger=false;
  }
},{passive:true});

/* ========== í¸ì§‘ íŒ¨ë„ ========== */
function showEditPanel(){
  $('editPanel').style.display='flex';
  $('heightDisplay').textContent=(heightOffset)+'mm';
  const type=selectedObj?.userData.type;
  if(type==='wall'){
    $('rotate90').style.display='inline-block';
  }else{
    $('rotate90').style.display='none';
  }
}
function hideEditPanel(){
  $('editPanel').style.display='none';
}

function rebuildSelected(){
  if(!selectedObj) return;
  const pos=selectedObj.position.clone();
  const quat=selectedObj.quaternion.clone();
  const py=selectedObj.userData._planeY??pos.y;
  scene.remove(selectedObj);
  const newModel=createModel();
  if(!newModel) return;
  newModel.position.copy(pos);
  newModel.quaternion.copy(quat);
  newModel.userData._planeY=py;
  scene.add(newModel);
  const i=placed.indexOf(selectedObj);
  if(i>=0) placed[i]=newModel;
  selectedObj=newModel;
}

// ì´ë™ (ì¹´ë©”ë¼ ê¸°ì¤€)
function moveObject(forward, right){
  if(!selectedObj) return;
  
  // ì¹´ë©”ë¼ ë°©í–¥ ë²¡í„° êµ¬í•˜ê¸°
  const cameraDirection = new THREE.Vector3();
  camera.getWorldDirection(cameraDirection);
  cameraDirection.y = 0; // ìˆ˜í‰ ë°©í–¥ë§Œ
  cameraDirection.normalize();
  
  // ì¹´ë©”ë¼ ì˜¤ë¥¸ìª½ ë°©í–¥ ë²¡í„°
  const cameraRight = new THREE.Vector3();
  cameraRight.crossVectors(cameraDirection, new THREE.Vector3(0, 1, 0));
  cameraRight.normalize();
  
  // ì´ë™ ë²¡í„° ê³„ì‚°
  const moveVector = new THREE.Vector3();
  moveVector.addScaledVector(cameraDirection, forward); // ì•ë’¤
  moveVector.addScaledVector(cameraRight, right); // ì¢Œìš°
  
  // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
  selectedObj.position.x += moveVector.x;
  selectedObj.position.z += moveVector.z;
  
  // Yì¶•ì€ í‰ë©´ ê¸°ì¤€ìœ¼ë¡œ ìœ ì§€
  if(selectedObj.userData._isWallMounted){
    // ë²½ê±¸ì´ëŠ” ì›ë˜ ìœ„ì¹˜ ìœ ì§€
  }else{
    const py = selectedObj.userData._planePos?.y ?? selectedObj.position.y;
    selectedObj.position.y = py + (heightOffset/1000);
  }
}

function setupMoveButton(btn, forward, right){
  let timer=null;
  const start=()=>{moveObject(forward, right); timer=setInterval(()=>moveObject(forward, right),100);};
  const stop=()=>{if(timer){clearInterval(timer); timer=null;}};
  btn.addEventListener('touchstart',start,{passive:true});
  btn.addEventListener('mousedown',start);
  ['touchend','touchcancel','mouseup','mouseleave'].forEach(e=>btn.addEventListener(e,stop));
}

// ë°©í–¥í‚¤ ì„¤ì • (ì¹´ë©”ë¼ ê¸°ì¤€)
// forward: ì–‘ìˆ˜=ì•ìœ¼ë¡œ, ìŒìˆ˜=ë’¤ë¡œ
// right: ì–‘ìˆ˜=ì˜¤ë¥¸ìª½, ìŒìˆ˜=ì™¼ìª½
setupMoveButton($('padUp'), 0.05, 0);      // ìœ„: ì•ìœ¼ë¡œ
setupMoveButton($('padDown'), -0.05, 0);   // ì•„ë˜: ë’¤ë¡œ
setupMoveButton($('padLeft'), 0, -0.05);   // ì™¼ìª½: ì™¼ìª½
setupMoveButton($('padRight'), 0, 0.05);   // ì˜¤ë¥¸ìª½: ì˜¤ë¥¸ìª½

// íšŒì „
$('rotLeft').onclick=()=>{
  if(!selectedObj) return;
  selectedObj.rotation.y+=THREE.MathUtils.degToRad(15);
};
$('rotRight').onclick=()=>{
  if(!selectedObj) return;
  selectedObj.rotation.y-=THREE.MathUtils.degToRad(15);
};

// 90ë„ íšŒì „
$('rotate90').onclick=()=>{
  if(!selectedObj || selectedObj.userData.type!=='wall') return;
  selectedObj.rotation.z=(selectedObj.rotation.z+Math.PI/2)%(Math.PI*2);
  const deg=THREE.MathUtils.radToDeg(selectedObj.rotation.z)%360;
  if(deg===90 || deg===270) showToast('ì„¸ë¡œ ëª¨ë“œ');
  else showToast('ê°€ë¡œ ëª¨ë“œ');
};

// ë†’ì´
$('heightUp').onclick=()=>{
  heightOffset+=50;
  $('heightDisplay').textContent=(heightOffset)+'mm';
  if(selectedObj){
    const py=selectedObj.userData._planeY??selectedObj.position.y;
    selectedObj.position.y=py+(heightOffset/1000);
  }
};
$('heightDown').onclick=()=>{
  heightOffset-=50;
  $('heightDisplay').textContent=(heightOffset)+'mm';
  if(selectedObj){
    const py=selectedObj.userData._planeY??selectedObj.position.y;
    selectedObj.position.y=py+(heightOffset/1000);
  }
};

// ì‚­ì œ
$('deleteObj').onclick=()=>{
  if(!selectedObj) return;
  scene.remove(selectedObj);
  const i=placed.indexOf(selectedObj);
  if(i>=0) placed.splice(i,1);
  selectedObj=null;
  hideEditPanel();
  showToast('ëª¨ë¸ ì‚­ì œë¨');
};

// ì™„ë£Œ
$('closeEdit').onclick=()=>{
  selectedObj=null;
  hideEditPanel();
};

/* ========== ìº¡ì²˜ ========== */
function hideUI(hide){
  ['topBar','bottomTray','fabContainer','editPanel','capStrip','toast','debug'].forEach(id=>{
    const el=$(id); if(el) el.style.visibility=hide?'hidden':'visible';
  });
  $('reticle').style.opacity=hide?'0':'1';
  $('statusBar').style.display='none';
}

function timestamp(){
  const d=new Date();
  const p=n=>String(n).padStart(2,'0');
  return d.getFullYear()+''+p(d.getMonth()+1)+p(d.getDate())+'_'+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds());
}

async function captureScene(){
  if(!placed.length){showToast('ë°°ì¹˜ í›„ ìº¡ì²˜ ê°€ëŠ¥'); return;}
  
  log('ìŠ¤í¬ë¦°ìƒ· ì´¬ì˜ ì‹œì‘');
  showToast('ğŸ“¸ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');
  
  // UI ìˆ¨ê¸°ê¸°
  hideUI(true);
  
  await new Promise(resolve=>setTimeout(resolve, 50));
  
  try{
    // ğŸ”¥ í•µì‹¬ ìˆ˜ì •: ì˜¤í”„ìŠ¤í¬ë¦° ìº”ë²„ìŠ¤ì— ë Œë”ë§
    const width = window.innerWidth * window.devicePixelRatio;
    const height = window.innerHeight * window.devicePixelRatio;
    
    // ì˜¤í”„ìŠ¤í¬ë¦° ë Œë”ëŸ¬ ìƒì„±
    const offscreenCanvas = document.createElement('canvas');
    offscreenCanvas.width = width;
    offscreenCanvas.height = height;
    
    const offscreenRenderer = new THREE.WebGLRenderer({
      canvas: offscreenCanvas,
      antialias: true,
      alpha: true,
      preserveDrawingBuffer: true  // ì¤‘ìš”!
    });
    offscreenRenderer.setSize(width, height, false);
    offscreenRenderer.setClearColor(0x000000, 0);
    
    // í˜„ì¬ ì¹´ë©”ë¼ í–‰ë ¬ ë³µì‚¬
    const tempCamera = camera.clone();
    tempCamera.aspect = width / height;
    tempCamera.updateProjectionMatrix();
    
    // ì˜¤í”„ìŠ¤í¬ë¦°ì— ë Œë”ë§
    offscreenRenderer.render(scene, tempCamera);
    
    log(`ì˜¤í”„ìŠ¤í¬ë¦° ë Œë”ë§ ì™„ë£Œ: ${width}x${height}`);
    
    // toDataURLë¡œ ì¶”ì¶œ (ì´ì œ ë™ì‘í•¨!)
    const dataUrl = offscreenCanvas.toDataURL('image/jpeg', 0.92);
    
    if(dataUrl.length < 1000){
      throw new Error('ì´ë¯¸ì§€ ë°ì´í„°ê°€ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤');
    }
    
    log(`ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ: ${dataUrl.length} bytes`);
    
    // íŒŒì¼ëª…
    const filename = 'DID_AR_' + timestamp() + '.jpg';
    
    // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± (ê°¤ëŸ¬ë¦¬ì— ìë™ ì €ì¥ë¨)
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    
    // ì •ë¦¬
    setTimeout(() => {
      document.body.removeChild(a);
      offscreenRenderer.dispose();
    }, 100);
    
    showToast('âœ… ì‚¬ì§„ì´ ë‹¤ìš´ë¡œë“œ í´ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    log('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ' + filename);
    
    // ì¸ë„¤ì¼ ì¶”ê°€
    const thumb = document.createElement('img');
    thumb.src = dataUrl;
    thumb.style.cssText='width:80px;height:80px;object-fit:cover;border-radius:8px;margin:5px;cursor:pointer;';
    thumb.onclick = () => {
      const viewer = window.open('', '_blank');
      viewer.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto;">`);
    };
    $('capStrip').prepend(thumb);
    
  }catch(err){
    log('ìº¡ì²˜ ì‹¤íŒ¨: ' + err.message);
    console.error('Capture error:', err);
    alert('ìŠ¤í¬ë¦°ìƒ· ì´¬ì˜ ì‹¤íŒ¨: ' + err.message);
  }finally{
    hideUI(false);
  }
}

/* ========== í† ìŠ¤íŠ¸ ========== */
const toast=$('toast');
function showToast(msg){
  toast.textContent=msg;
  toast.style.display='block';
  setTimeout(()=>toast.style.display='none',1500);
}

/* ========== AR ì‹œì‘ ========== */
const startBtn=$('startBtn'), placeBtn=$('placeBtn'), captureBtn=$('captureBtn');
const startBtnBig=$('startBtnBig'), startScreen=$('startScreen');
let arBtn=null;

function startAR(){
  log('AR ì‹œì‘ ë²„íŠ¼ í´ë¦­ë¨');
  
  if(!('xr' in navigator)){
    log('âŒ WebXR ë¯¸ì§€ì› (navigator.xr ì—†ìŒ)');
    alert('ì´ ë¸Œë¼ìš°ì €ëŠ” WebXRì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome/Edgeë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if(!self.isSecureContext){
    log('âŒ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ ì•„ë‹˜ (HTTPS í•„ìš”)');
    alert('HTTPS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
    return;
  }
  
  // AR ì§€ì› ì—¬ë¶€ í™•ì¸
  navigator.xr.isSessionSupported('immersive-ar').then(supported=>{
    if(!supported){
      log('âŒ AR ì„¸ì…˜ ë¯¸ì§€ì›');
      alert('ì´ ê¸°ê¸°ëŠ” ARì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }
    
    log('âœ“ AR ì§€ì› í™•ì¸ë¨, ì„¸ì…˜ ì‹œì‘ ì¤‘...');
    
    if(!arBtn){
      arBtn = ARButton.createButton(renderer, {
        requiredFeatures:['hit-test'],
        optionalFeatures:['dom-overlay'],
        domOverlay:{root:document.body}
      });
      arBtn.style.display='none';
      document.body.appendChild(arBtn);
    }
    
    try{
      arBtn.click();
      setTimeout(()=>{
        if(renderer.xr.isPresenting){
          // ì‹œì‘ í™”ë©´ ìˆ¨ê¸°ê¸°
          startScreen.classList.add('hidden');
          // Canvas í‘œì‹œ
          renderer.domElement.classList.add('ar-active');
          // UI ìš”ì†Œë“¤ í‘œì‹œ
          $('topBar').style.display='flex';
          $('bottomTray').style.display='flex';
          startBtn.style.display='none';
          placeBtn.style.display='block';
          captureBtn.style.display='block';
          
          // Pre-uploaded íŒŒì¼ ë¡œë“œ
          if(preUploadedFiles.length > 0){
            log(`ë¯¸ë¦¬ ì—…ë¡œë“œëœ íŒŒì¼ ${preUploadedFiles.length}ê°œ ë¡œë“œ ì¤‘`);
            preUploadedFiles.forEach((file, idx) => {
              if(file.type.startsWith('image/')){
                addScreenThumbnail(file.url, idx === 0);
              }
            });
            showToast(`âœ“ ${preUploadedFiles.length}ê°œ íŒŒì¼ ì ìš©ë¨`);
          }
          
          log('âœ“ AR ì„¸ì…˜ í™œì„±í™”ë¨');
          showToast('AR ì„¸ì…˜ ì‹œì‘ë¨');
        }else{
          log('âš ï¸ AR ì„¸ì…˜ ì‹œì‘ ì§€ì—°');
        }
      },1000);
    }catch(e){
      log('âŒ AR ë²„íŠ¼ í´ë¦­ ì‹¤íŒ¨: '+e.message);
    }
  }).catch(err=>{
    log('âŒ AR ì§€ì› í™•ì¸ ì‹¤íŒ¨: '+err.message);
    alert('AR ì§€ì› í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  });
}

// ì‹œì‘ í™”ë©´ ë²„íŠ¼ë“¤
startBtnBig.onclick=startAR;
startBtn.onclick=startAR;

placeBtn.onclick=placeModel;
captureBtn.onclick=captureScene;

/* ========== ë¦¬ì‚¬ì´ì¦ˆ ========== */
window.addEventListener('resize',()=>{
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// ì´ˆê¸° ë¡œë”© ì™„ë£Œ
log('âœ“ ì•± ì¤€ë¹„ ì™„ë£Œ! AR ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');

// ë””ë²„ê·¸ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸° (ê°œë°œ ì¤‘ì—ë§Œ í‘œì‹œ)
setTimeout(()=>{
  if(debugEl) debugEl.style.display = 'none';
}, 2000);

</script>
</body>
</html>
