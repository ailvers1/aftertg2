<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DID AR</title>
<style>
body{margin:0;font-family:sans-serif;background:#000}
canvas{position:absolute;top:0;left:0;width:100%;height:100%}

#ui{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#667eea,#764ba2);z-index:10;
}
#ui.hidden{display:none}

#start{
  background:#fff;color:#667eea;border:none;border-radius:50px;
  padding:20px 50px;font-size:20px;font-weight:bold;cursor:pointer;
}

#controls{
  position:fixed;right:20px;bottom:100px;z-index:20;display:none;
}
#place{
  background:#0ea5e9;color:#fff;border:none;border-radius:12px;
  padding:15px 25px;font-size:16px;font-weight:bold;cursor:pointer;
}

#msg{
  position:fixed;bottom:200px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.9);color:#fff;padding:12px 20px;
  border-radius:8px;display:none;z-index:20;
}
</style>
</head>
<body>

<div id="ui">
  <button id="start">AR 시작</button>
</div>

<div id="controls">
  <button id="place">배치</button>
</div>

<div id="msg"></div>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import {ARButton} from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/webxr/ARButton.js';

const ui=document.getElementById('ui');
const startBtn=document.getElementById('start');
const controls=document.getElementById('controls');
const placeBtn=document.getElementById('place');
const msg=document.getElementById('msg');

function showMsg(text){
  msg.textContent=text;
  msg.style.display='block';
  setTimeout(()=>msg.style.display='none',2000);
}

// Scene
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.01,20);

const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.xr.enabled=true;
document.body.appendChild(renderer.domElement);

// Light
const light=new THREE.HemisphereLight(0xffffff,0xbbbbff,1);
scene.add(light);

// Reticle
const reticle=new THREE.Mesh(
  new THREE.RingGeometry(0.15,0.2,32).rotateX(-Math.PI/2),
  new THREE.MeshBasicMaterial()
);
reticle.matrixAutoUpdate=false;
reticle.visible=false;
scene.add(reticle);

// Model
function createModel(){
  const group=new THREE.Group();
  
  const box=new THREE.Mesh(
    new THREE.BoxGeometry(0.6,0.4,0.03),
    new THREE.MeshStandardMaterial({color:0x222222})
  );
  group.add(box);
  
  const screen=new THREE.Mesh(
    new THREE.PlaneGeometry(0.55,0.35),
    new THREE.MeshBasicMaterial({color:0x3366ff})
  );
  screen.position.z=0.016;
  group.add(screen);
  
  return group;
}

// Hit test
let hitTestSource=null;
let hitTestSourceRequested=false;

function onSessionStart(){
  ui.classList.add('hidden');
  controls.style.display='block';
  showMsg('바닥을 비춰주세요');
}

function onSessionEnd(){
  hitTestSourceRequested=false;
  hitTestSource=null;
  ui.classList.remove('hidden');
  controls.style.display='none';
}

renderer.setAnimationLoop((time,frame)=>{
  if(frame){
    const refSpace=renderer.xr.getReferenceSpace();
    const session=renderer.xr.getSession();
    
    if(hitTestSourceRequested===false){
      session.requestReferenceSpace('viewer').then((refSpace)=>{
        session.requestHitTestSource({space:refSpace}).then((source)=>{
          hitTestSource=source;
        });
      });
      
      session.addEventListener('end',onSessionEnd);
      hitTestSourceRequested=true;
    }
    
    if(hitTestSource){
      const hitTestResults=frame.getHitTestResults(hitTestSource);
      if(hitTestResults.length){
        const hit=hitTestResults[0];
        reticle.visible=true;
        reticle.matrix.fromArray(hit.getPose(refSpace).transform.matrix);
      }else{
        reticle.visible=false;
      }
    }
  }
  
  renderer.render(scene,camera);
});

// Place button
placeBtn.onclick=()=>{
  if(reticle.visible){
    const model=createModel();
    model.position.setFromMatrixPosition(reticle.matrix);
    scene.add(model);
    showMsg('배치 완료!');
  }else{
    showMsg('바닥을 먼저 인식하세요');
  }
};

// Start AR
startBtn.onclick=()=>{
  const arButton=ARButton.createButton(renderer,{
    requiredFeatures:['hit-test']
  });
  
  arButton.style.display='none';
  document.body.appendChild(arButton);
  arButton.click();
  
  setTimeout(()=>{
    if(renderer.xr.isPresenting){
      onSessionStart();
    }
  },500);
};

// Resize
window.addEventListener('resize',()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
