<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>DID AR Professional</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#1a1a2e;font-family:system-ui,-apple-system,sans-serif}
  
  /* ì‹œì‘ í™”ë©´ */
  #startScreen{
    position:fixed;inset:0;z-index:100;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;
  }
  #startScreen.hidden{display:none}
  #startLogo{font-size:48px;margin-bottom:20px;animation:float 3s ease-in-out infinite}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
  #startTitle{color:#fff;font-size:28px;font-weight:700;margin-bottom:12px;text-align:center}
  #startDesc{color:rgba(255,255,255,0.9);font-size:16px;margin-bottom:30px;text-align:center;max-width:400px;line-height:1.6}
  #startBtnBig{
    background:#fff;color:#667eea;border:none;border-radius:50px;
    padding:20px 60px;font-size:20px;font-weight:700;cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,0.3);transition:all 0.3s;
    user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;
    touch-action:manipulation;min-height:60px;
  }
  #startBtnBig:active{transform:scale(0.97);box-shadow:0 4px 15px rgba(0,0,0,0.3)}
  
  /* Three.js canvas */
  canvas{position:fixed;inset:0;touch-action:none;opacity:0;transition:opacity 0.3s;z-index:1}
  canvas.ar-active{opacity:1}
  
  /* FAB ë²„íŠ¼ - ë°©í–¥ ëŒ€ì‘ */
  #fabContainer{
    position:fixed;z-index:9999;display:none;
    transition:all 0.3s ease;pointer-events:none;
  }
  body.portrait #fabContainer{right:16px;bottom:100px}
  body.landscape #fabContainer{right:16px;top:50%;transform:translateY(-50%)}
  
  .fab{
    padding:18px 28px;border-radius:14px;font-weight:600;border:none;
    box-shadow:0 4px 16px rgba(0,0,0,.7);color:#fff;cursor:pointer;font-size:16px;
    min-width:130px;text-align:center;position:relative;
    pointer-events:auto;user-select:none;-webkit-user-select:none;
    -webkit-tap-highlight-color:transparent;touch-action:manipulation;
    min-height:50px;display:flex;align-items:center;justify-content:center;
    background:#0ea5e9;
  }
  .fab::before{content:'';position:absolute;inset:-12px}
  .fab:active{transform:scale(0.95);box-shadow:0 2px 8px rgba(0,0,0,.6)}
  
  /* í† ìŠ¤íŠ¸ - ë°©í–¥ ëŒ€ì‘ */
  #toast{
    position:fixed;left:50%;transform:translateX(-50%);z-index:10000;
    background:rgba(0,0,0,.9);color:#fff;padding:14px 20px;border-radius:10px;
    display:none;font-size:15px;box-shadow:0 4px 12px rgba(0,0,0,.6);white-space:nowrap;
    transition:all 0.3s ease;font-weight:500;
  }
  body.portrait #toast{bottom:180px}
  body.landscape #toast{bottom:80px}
  
  /* ë¦¬í‹°í´ */
  #reticle{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:180px;height:180px;border:4px solid #4fc3ff;border-radius:50%;
    pointer-events:none;z-index:15;opacity:0;transition:opacity 0.3s;
    box-shadow:0 0 40px rgba(79,195,255,.8) inset,0 0 30px rgba(79,195,255,.7);
    animation:pulse 2s ease-in-out infinite;
  }
  @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.05)}}
  #reticle::after{
    content:'ë°°ì¹˜ ìœ„ì¹˜';position:absolute;left:50%;bottom:-35px;transform:translateX(-50%);
    color:#4fc3ff;font-size:13px;font-weight:600;text-shadow:0 2px 8px rgba(0,0,0,.8);
  }
  
  /* ë°©í–¥ ì¸ë””ì¼€ì´í„° */
  #orientationIndicator{
    position:fixed;top:20px;left:20px;z-index:10000;
    background:rgba(0,0,0,0.7);color:#fff;padding:10px 16px;border-radius:10px;
    font-size:13px;font-weight:600;display:none;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  #orientationIndicator.show{display:block}
  
  /* ìŠ¤í¬ë¦°ìƒ· ì•ˆë‚´ */
  #screenshotGuide{
    position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:10000;
    background:rgba(102,126,234,0.95);color:#fff;padding:12px 20px;border-radius:10px;
    font-size:14px;font-weight:500;display:none;text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);max-width:90%;
  }
  #screenshotGuide.show{display:block}
</style>
</head>
<body class="portrait">

<div id="startScreen">
  <div id="startLogo">ğŸ“±âœ¨</div>
  <div id="startTitle">DID AR Professional</div>
  <div id="startDesc">ì¦ê°•í˜„ì‹¤ë¡œ ì‚¼ì„± DID ë””ìŠ¤í”Œë ˆì´ë¥¼ ì‹¤ì œ ê³µê°„ì— ë°°ì¹˜í•˜ê³  ì²´í—˜í•´ë³´ì„¸ìš”<br><small style="opacity:0.8">ğŸ’¡ ê°€ë¡œ/ì„¸ë¡œ ëª¨ë“œ ìë™ ëŒ€ì‘<br>ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·ì€ ê¸°ê¸° ë²„íŠ¼ìœ¼ë¡œ ì´¬ì˜í•˜ì„¸ìš”</small></div>
  <button id="startBtnBig">ğŸš€ AR ì‹œì‘í•˜ê¸°</button>
</div>

<div id="reticle"></div>

<div id="fabContainer">
  <button id="placeBtn" class="fab">ğŸ“ ë°°ì¹˜í•˜ê¸°</button>
</div>

<div id="toast"></div>
<div id="orientationIndicator"></div>
<div id="screenshotGuide">ğŸ’¡ ìŠ¤í¬ë¦°ìƒ·ì€ í•¸ë“œí°ì˜ ìŠ¤í¬ë¦°ìƒ· ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

const $=id=>document.getElementById(id);
const startScreen=$('startScreen'), startBtnBig=$('startBtnBig');
const placeBtn=$('placeBtn');
const toast=$('toast'), reticle=$('reticle');
const orientationInd=$('orientationIndicator');
const screenshotGuide=$('screenshotGuide');

// í˜„ì¬ ë°©í–¥ ì¶”ì 
let currentOrientation='portrait';

function showToast(msg){
  toast.textContent=msg;
  toast.style.display='block';
  setTimeout(()=>toast.style.display='none',2500);
}

// ë°©í–¥ ê°ì§€ ë° ì—…ë°ì´íŠ¸
function updateOrientation(){
  const w=window.innerWidth;
  const h=window.innerHeight;
  const isLandscape=w>h;
  
  const newOrientation=isLandscape?'landscape':'portrait';
  
  if(newOrientation!==currentOrientation){
    currentOrientation=newOrientation;
    document.body.className=currentOrientation;
    
    if(renderer && renderer.xr.isPresenting){
      orientationInd.textContent=isLandscape?'ğŸ“± ê°€ë¡œ ëª¨ë“œ (16:9)':'ğŸ“± ì„¸ë¡œ ëª¨ë“œ (9:16)';
      orientationInd.classList.add('show');
      setTimeout(()=>orientationInd.classList.remove('show'),2000);
    }
  }
  
  if(camera){
    camera.aspect=w/h;
    camera.updateProjectionMatrix();
  }
  
  if(renderer){
    renderer.setSize(w,h);
  }
}

updateOrientation();
window.addEventListener('resize',updateOrientation);
window.addEventListener('orientationchange',()=>setTimeout(updateOrientation,100));
if(screen.orientation){
  screen.orientation.addEventListener('change',()=>setTimeout(updateOrientation,100));
}

// Three.js ì´ˆê¸°í™” - alpha:falseë¡œ ì¹´ë©”ë¼ ë°°ê²½ ë³´ì´ë„ë¡
let renderer,scene,camera,dir;
try{
  renderer=new THREE.WebGLRenderer({
    antialias:true,
    alpha:false,
    preserveDrawingBuffer:true
  });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.xr.enabled=true;
  document.body.appendChild(renderer.domElement);
  
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.01,100);
  
  scene.add(new THREE.HemisphereLight(0xffffff,0x888888,1.2));
  dir=new THREE.DirectionalLight(0xffffff,1.5);
  dir.position.set(0.5,1,0.3);
  scene.add(dir);
  scene.add(new THREE.AmbientLight(0xffffff,0.5));
}catch(e){
  alert('ì´ˆê¸°í™” ì‹¤íŒ¨: '+e.message);
  throw e;
}

// ê°„ë‹¨í•œ ëª¨ë¸
const placed=[];
function createSimpleModel(){
  const group=new THREE.Group();
  const box=new THREE.Mesh(
    new THREE.BoxGeometry(1,0.6,0.05),
    new THREE.MeshStandardMaterial({color:0x111111,roughness:0.5,metalness:0.4})
  );
  box.position.y=0.3;
  group.add(box);
  
  const screen=new THREE.Mesh(
    new THREE.PlaneGeometry(0.95,0.55),
    new THREE.MeshStandardMaterial({color:0x3333ff,emissive:0x111144,emissiveIntensity:0.5})
  );
  screen.position.set(0,0.3,0.026);
  group.add(screen);
  
  return group;
}

// Hit-test
let hitSource=null,lastHitPose=null;

renderer.setAnimationLoop((_,frame)=>{
  if(frame){
    const ref=renderer.xr.getReferenceSpace();
    const session=renderer.xr.getSession();
    
    if(!hitSource && session){
      session.requestReferenceSpace('viewer').then(view=>{
        session.requestHitTestSource({space:view}).then(src=>hitSource=src);
      });
      
      session.addEventListener('end',()=>{
        hitSource=null;
        startScreen.classList.remove('hidden');
        renderer.domElement.classList.remove('ar-active');
        $('fabContainer').style.display='none';
        reticle.style.opacity='0';
        orientationInd.classList.remove('show');
        screenshotGuide.classList.remove('show');
      });
    }
    
    if(hitSource){
      const hits=frame.getHitTestResults(hitSource);
      if(hits.length){
        lastHitPose=hits[0].getPose(ref);
        reticle.style.opacity='1';
      }else{
        lastHitPose=null;
        reticle.style.opacity='0';
      }
    }
  }
  renderer.render(scene,camera);
});

// ë°°ì¹˜
let isPlacing=false;
function doPlace(){
  if(isPlacing)return;
  isPlacing=true;
  
  if(!lastHitPose){
    showToast('ë°”ë‹¥ì„ ì¸ì‹í•´ì£¼ì„¸ìš”');
    isPlacing=false;
    return;
  }
  
  const model=createSimpleModel();
  const m=new THREE.Matrix4().fromArray(lastHitPose.transform.matrix);
  const pos=new THREE.Vector3().setFromMatrixPosition(m);
  model.position.copy(pos);
  
  scene.add(model);
  placed.push(model);
  showToast(`âœ… ëª¨ë¸ ë°°ì¹˜ë¨ (${placed.length}ê°œ)`);
  
  // ì²« ë°°ì¹˜ ì‹œ ìŠ¤í¬ë¦°ìƒ· ì•ˆë‚´ í‘œì‹œ
  if(placed.length===1){
    screenshotGuide.classList.add('show');
    setTimeout(()=>screenshotGuide.classList.remove('show'),5000);
  }
  
  setTimeout(()=>isPlacing=false,500);
}

placeBtn.addEventListener('touchstart',e=>e.preventDefault(),{passive:false});
placeBtn.addEventListener('touchend',e=>{e.preventDefault();doPlace();},{passive:false});
placeBtn.addEventListener('click',e=>{e.preventDefault();doPlace();});

// AR ì‹œì‘
let isStarting=false;
async function doStartAR(){
  console.log('ğŸ”µ doStartAR í˜¸ì¶œë¨');
  
  if(isStarting){
    console.log('âš ï¸ ì´ë¯¸ ì‹œì‘ ì¤‘');
    return;
  }
  isStarting=true;
  
  console.log('âœ… AR ì‹œì‘ í”„ë¡œì„¸ìŠ¤ ì‹œì‘');
  showToast('AR ì¤€ë¹„ ì¤‘...');
  
  if(!('xr' in navigator)){
    console.log('âŒ navigator.xr ì—†ìŒ');
    alert('WebXRì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”');
    isStarting=false;
    return;
  }
  console.log('âœ… navigator.xr ì¡´ì¬');
  
  if(!self.isSecureContext){
    console.log('âŒ HTTPS ì•„ë‹˜');
    alert('HTTPS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤');
    isStarting=false;
    return;
  }
  console.log('âœ… HTTPS í™•ì¸');
  
  try{
    console.log('ğŸ” AR ì§€ì› ì²´í¬ ì¤‘...');
    const supported=await navigator.xr.isSessionSupported('immersive-ar');
    console.log('AR ì§€ì› ì—¬ë¶€:',supported);
    
    if(!supported){
      alert('ì´ ê¸°ê¸°ëŠ” ARì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nChrome ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
      isStarting=false;
      return;
    }
    
    console.log('âœ… AR ì§€ì›ë¨, ì„¸ì…˜ ìš”ì²­ ì¤‘...');
    showToast('ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”...');
    
    // ARButton ëŒ€ì‹  ì§ì ‘ ì„¸ì…˜ ìš”ì²­
    const session=await navigator.xr.requestSession('immersive-ar',{
      requiredFeatures:['hit-test']
    });
    
    console.log('âœ… AR ì„¸ì…˜ ìƒì„±ë¨');
    
    await renderer.xr.setSession(session);
    console.log('âœ… ë Œë”ëŸ¬ì— ì„¸ì…˜ ì„¤ì • ì™„ë£Œ');
    
    startScreen.classList.add('hidden');
    renderer.domElement.classList.add('ar-active');
    $('fabContainer').style.display='block';
    
    const isLandscape=currentOrientation==='landscape';
    orientationInd.textContent=isLandscape?'ğŸ“± ê°€ë¡œ ëª¨ë“œ (16:9)':'ğŸ“± ì„¸ë¡œ ëª¨ë“œ (9:16)';
    orientationInd.classList.add('show');
    setTimeout(()=>orientationInd.classList.remove('show'),3000);
    
    showToast('AR ì‹œì‘! ë°”ë‹¥ì„ ë¹„ì¶°ì£¼ì„¸ìš”');
    
    session.addEventListener('end',()=>{
      console.log('AR ì„¸ì…˜ ì¢…ë£Œ');
      hitSource=null;
      startScreen.classList.remove('hidden');
      renderer.domElement.classList.remove('ar-active');
      $('fabContainer').style.display='none';
      reticle.style.opacity='0';
      orientationInd.classList.remove('show');
      screenshotGuide.classList.remove('show');
      isStarting=false;
    });
    
    console.log('ğŸ‰ AR ì™„ì „íˆ ì‹œì‘ë¨!');
    isStarting=false;
    
  }catch(e){
    console.error('âŒ AR ì‹œì‘ ì‹¤íŒ¨:',e);
    console.error('ì—ëŸ¬ ì´ë¦„:',e.name);
    console.error('ì—ëŸ¬ ë©”ì‹œì§€:',e.message);
    alert('AR ì‹œì‘ ì‹¤íŒ¨: '+e.message+'\n\nì—ëŸ¬ íƒ€ì…: '+e.name);
    isStarting=false;
  }
}

startBtnBig.addEventListener('touchstart',e=>{
  console.log('ğŸ‘† Start ë²„íŠ¼ touchstart');
  e.preventDefault();
},{passive:false});

startBtnBig.addEventListener('touchend',e=>{
  console.log('ğŸ‘† Start ë²„íŠ¼ touchend');
  e.preventDefault();
  doStartAR();
},{passive:false});

startBtnBig.addEventListener('click',e=>{
  console.log('ğŸ‘† Start ë²„íŠ¼ click');
  e.preventDefault();
  doStartAR();
});
</script>
</body>
</html>
