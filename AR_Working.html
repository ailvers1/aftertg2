<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>AR Working Version</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;overflow:hidden;background:#000;font-family:sans-serif}
  
  #overlay{
    position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.9);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    color:#fff;padding:20px;
  }
  #overlay.hidden{display:none}
  
  h1{font-size:32px;margin-bottom:30px;text-align:center}
  
  button{
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color:#fff;border:none;border-radius:50px;
    padding:20px 50px;font-size:20px;font-weight:700;
    margin:15px;cursor:pointer;min-width:250px;
    box-shadow:0 8px 20px rgba(0,0,0,0.4);
    touch-action:manipulation;
    -webkit-tap-highlight-color:transparent;
  }
  button:active{transform:scale(0.95)}
  button:disabled{background:#555;cursor:not-allowed}
  
  #status{
    margin-top:20px;padding:15px 25px;background:rgba(255,255,255,0.1);
    border-radius:10px;font-size:16px;text-align:center;
  }
  
  #arControls{
    position:fixed;bottom:30px;right:20px;z-index:200;
    display:none;flex-direction:column;gap:15px;
  }
  #arControls button{
    min-width:150px;padding:18px 30px;font-size:16px;
  }
  
  #message{
    position:fixed;bottom:150px;left:50%;transform:translateX(-50%);
    z-index:200;background:rgba(0,0,0,0.9);color:#fff;
    padding:15px 25px;border-radius:10px;display:none;
    font-size:16px;box-shadow:0 4px 12px rgba(0,0,0,0.6);
  }
  
  canvas{position:fixed;inset:0}
</style>
</head>
<body>

<div id="overlay">
  <h1>ğŸ¯ AR ë””ìŠ¤í”Œë ˆì´ ë°°ì¹˜</h1>
  <button id="startBtn">ğŸš€ AR ì‹œì‘í•˜ê¸°</button>
  <div id="status">ì¤€ë¹„ ì™„ë£Œ</div>
</div>

<div id="arControls">
  <button id="placeBtn">ğŸ“ ë°°ì¹˜í•˜ê¸°</button>
  <button id="captureBtn">ğŸ“¸ ìº¡ì²˜í•˜ê¸°</button>
</div>

<div id="message"></div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

const startBtn=document.getElementById('startBtn');
const overlay=document.getElementById('overlay');
const arControls=document.getElementById('arControls');
const placeBtn=document.getElementById('placeBtn');
const captureBtn=document.getElementById('captureBtn');
const status=document.getElementById('status');
const messageDiv=document.getElementById('message');

function showMessage(msg){
  messageDiv.textContent=msg;
  messageDiv.style.display='block';
  setTimeout(()=>messageDiv.style.display='none',2500);
}

// Three.js ì´ˆê¸°í™”
let renderer,scene,camera,reticle,hitTestSource,hitTestSourceRequested=false;
const placed=[];

renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth,window.innerHeight);
renderer.xr.enabled=true;
document.body.appendChild(renderer.domElement);

scene=new THREE.Scene();
camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.01,20);

const light=new THREE.HemisphereLight(0xffffff,0xbbbbff,1);
light.position.set(0.5,1,0.25);
scene.add(light);

// ë¦¬í‹°í´ (ë°”ë‹¥ í‘œì‹œ)
const geometry=new THREE.RingGeometry(0.15,0.2,32).rotateX(-Math.PI/2);
const material=new THREE.MeshBasicMaterial({color:0x00ffff,side:THREE.DoubleSide});
reticle=new THREE.Mesh(geometry,material);
reticle.matrixAutoUpdate=false;
reticle.visible=false;
scene.add(reticle);

// ëª¨ë¸ ìƒì„±
function createModel(){
  const group=new THREE.Group();
  
  // ë³¸ì²´
  const box=new THREE.Mesh(
    new THREE.BoxGeometry(0.6,0.4,0.03),
    new THREE.MeshStandardMaterial({color:0x222222,metalness:0.3,roughness:0.7})
  );
  group.add(box);
  
  // í™”ë©´
  const screen=new THREE.Mesh(
    new THREE.PlaneGeometry(0.55,0.35),
    new THREE.MeshBasicMaterial({color:0x3366ff})
  );
  screen.position.z=0.016;
  group.add(screen);
  
  return group;
}

// ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
function animate(){
  renderer.setAnimationLoop(render);
}

function render(timestamp,frame){
  if(frame){
    const referenceSpace=renderer.xr.getReferenceSpace();
    const session=renderer.xr.getSession();
    
    if(!hitTestSourceRequested){
      session.requestReferenceSpace('viewer').then(refSpace=>{
        session.requestHitTestSource({space:refSpace}).then(source=>{
          hitTestSource=source;
        });
      });
      
      session.addEventListener('end',()=>{
        hitTestSourceRequested=false;
        hitTestSource=null;
        overlay.classList.remove('hidden');
        arControls.style.display='none';
      });
      
      hitTestSourceRequested=true;
    }
    
    if(hitTestSource){
      const hitTestResults=frame.getHitTestResults(hitTestSource);
      
      if(hitTestResults.length){
        const hit=hitTestResults[0];
        reticle.visible=true;
        reticle.matrix.fromArray(hit.getPose(referenceSpace).transform.matrix);
      }else{
        reticle.visible=false;
      }
    }
  }
  
  renderer.render(scene,camera);
}

// AR ì‹œì‘
startBtn.onclick=async function(){
  status.textContent='AR ì´ˆê¸°í™” ì¤‘...';
  
  try{
    const session=await navigator.xr.requestSession('immersive-ar',{
      requiredFeatures:['hit-test'],
      optionalFeatures:['dom-overlay'],
      domOverlay:{root:document.body}
    });
    
    await renderer.xr.setSession(session);
    
    overlay.classList.add('hidden');
    arControls.style.display='flex';
    showMessage('ë°”ë‹¥ì„ ë¹„ì¶°ì„œ íŒŒë€ ì›ì„ ì°¾ìœ¼ì„¸ìš”');
    
    animate();
    
  }catch(error){
    console.error('AR ì‹œì‘ ì‹¤íŒ¨:',error);
    status.textContent='âŒ AR ì‹œì‘ ì‹¤íŒ¨: '+error.message;
    
    if(error.message.includes('requestReferenceSpace')){
      status.textContent='âŒ ì´ ê¸°ê¸°ëŠ” ARì„ ì™„ì „íˆ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
    }else if(error.message.includes('already an active')){
      status.textContent='âŒ ì´ë¯¸ ARì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”';
    }else if(error.name==='NotAllowedError'){
      status.textContent='âŒ ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
    }
  }
};

// ë°°ì¹˜ ë²„íŠ¼
placeBtn.onclick=function(){
  if(reticle.visible){
    const model=createModel();
    model.position.setFromMatrixPosition(reticle.matrix);
    model.quaternion.setFromRotationMatrix(reticle.matrix);
    scene.add(model);
    placed.push(model);
    showMessage(`âœ… ëª¨ë¸ ë°°ì¹˜ë¨ (${placed.length}ê°œ)`);
  }else{
    showMessage('âš ï¸ ë°”ë‹¥ì„ ë¨¼ì € ì¸ì‹í•´ì£¼ì„¸ìš”');
  }
};

// ìº¡ì²˜ ë²„íŠ¼
captureBtn.onclick=async function(){
  if(placed.length===0){
    showMessage('âš ï¸ ëª¨ë¸ì„ ë¨¼ì € ë°°ì¹˜í•˜ì„¸ìš”');
    return;
  }
  
  showMessage('ğŸ“¸ ìº¡ì²˜ ì¤‘...');
  
  await new Promise(r=>setTimeout(r,100));
  
  try{
    const canvas=renderer.domElement;
    const dataUrl=canvas.toDataURL('image/jpeg',0.95);
    
    const a=document.createElement('a');
    a.href=dataUrl;
    a.download=`AR_Display_${Date.now()}.jpg`;
    a.click();
    
    showMessage('âœ… ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  }catch(error){
    showMessage('âŒ ìº¡ì²˜ ì‹¤íŒ¨: '+error.message);
  }
};

// ë¦¬ì‚¬ì´ì¦ˆ
window.addEventListener('resize',()=>{
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
});

console.log('App ready');
</script>
</body>
</html>
