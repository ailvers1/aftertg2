<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>DID AR Professional</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#1a1a2e;font-family:system-ui,-apple-system,sans-serif}
  
  /* ì‹œì‘ í™”ë©´ */
  #startScreen{
    position:fixed;inset:0;z-index:100;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;
  }
  #startScreen.hidden{display:none}
  #startLogo{font-size:48px;margin-bottom:20px;animation:float 3s ease-in-out infinite}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
  #startTitle{color:#fff;font-size:28px;font-weight:700;margin-bottom:12px;text-align:center}
  #startDesc{color:rgba(255,255,255,0.9);font-size:16px;margin-bottom:30px;text-align:center;max-width:400px;line-height:1.6}
  #startBtnBig{
    background:#fff;color:#667eea;border:none;border-radius:50px;
    padding:18px 50px;font-size:18px;font-weight:700;cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,0.3);transition:all 0.3s;
  }
  #startBtnBig:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(0,0,0,0.4)}
  
  /* Three.js canvas */
  canvas{position:fixed;inset:0;touch-action:none;opacity:0;transition:opacity 0.3s}
  canvas.ar-active{opacity:1}
  
  /* FAB ë²„íŠ¼ - ë°©í–¥ ëŒ€ì‘ */
  #fabContainer{
    position:fixed;z-index:22;display:none;flex-direction:column;gap:11px;
    transition:all 0.3s ease;
  }
  /* ì„¸ë¡œ ëª¨ë“œ: ì˜¤ë¥¸ìª½ í•˜ë‹¨ */
  body.portrait #fabContainer{
    right:14px;bottom:100px;
  }
  /* ê°€ë¡œ ëª¨ë“œ: ì˜¤ë¥¸ìª½ ì¤‘ì•™ */
  body.landscape #fabContainer{
    right:14px;top:50%;transform:translateY(-50%);
  }
  
  .fab{padding:13px 18px;border-radius:11px;font-weight:600;border:none;
    box-shadow:0 4px 16px rgba(0,0,0,.6);color:#fff;cursor:pointer;font-size:14px;min-width:105px;text-align:center}
  #placeBtn{background:#0ea5e9}
  #captureBtn{background:#f59e0b}
  
  /* í† ìŠ¤íŠ¸ - ë°©í–¥ ëŒ€ì‘ */
  #toast{
    position:fixed;left:50%;transform:translateX(-50%);z-index:40;
    background:rgba(0,0,0,.9);color:#fff;padding:12px 18px;border-radius:9px;
    display:none;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,.6);white-space:nowrap;
    transition:all 0.3s ease;
  }
  body.portrait #toast{bottom:150px}
  body.landscape #toast{bottom:80px}
  
  /* ë¦¬í‹°í´ */
  #reticle{
    position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
    width:180px;height:180px;border:4px solid #4fc3ff;border-radius:50%;
    pointer-events:none;z-index:15;opacity:0;transition:opacity 0.3s;
    box-shadow:0 0 40px rgba(79,195,255,.8) inset,0 0 30px rgba(79,195,255,.7);
    animation:pulse 2s ease-in-out infinite;
  }
  @keyframes pulse{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.05)}}
  #reticle::after{
    content:'ë°°ì¹˜ ìœ„ì¹˜';position:absolute;left:50%;bottom:-35px;transform:translateX(-50%);
    color:#4fc3ff;font-size:13px;font-weight:600;text-shadow:0 2px 8px rgba(0,0,0,.8);
  }
  
  /* ë°©í–¥ ì¸ë””ì¼€ì´í„° */
  #orientationIndicator{
    position:fixed;top:20px;left:20px;z-index:30;
    background:rgba(0,0,0,0.7);color:#fff;padding:8px 14px;border-radius:8px;
    font-size:12px;font-weight:600;display:none;
    box-shadow:0 2px 8px rgba(0,0,0,0.6);
  }
  #orientationIndicator.show{display:block}
</style>
</head>
<body class="portrait">

<div id="startScreen">
  <div id="startLogo">ğŸ“±âœ¨</div>
  <div id="startTitle">DID AR Professional</div>
  <div id="startDesc">ì¦ê°•í˜„ì‹¤ë¡œ ì‚¼ì„± DID ë””ìŠ¤í”Œë ˆì´ë¥¼ ì‹¤ì œ ê³µê°„ì— ë°°ì¹˜í•˜ê³  ì²´í—˜í•´ë³´ì„¸ìš”<br><small style="opacity:0.8">ğŸ’¡ ê°€ë¡œ/ì„¸ë¡œ ëª¨ë“œ ìë™ ëŒ€ì‘</small></div>
  <button id="startBtnBig">ğŸš€ AR ì‹œì‘í•˜ê¸°</button>
</div>

<div id="reticle"></div>

<div id="fabContainer">
  <button id="placeBtn" class="fab">ğŸ“ ë°°ì¹˜í•˜ê¸°</button>
  <button id="captureBtn" class="fab">ğŸ“¸ ìŠ¤í¬ë¦°ìƒ·</button>
</div>

<div id="toast"></div>
<div id="orientationIndicator"></div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

const $=id=>document.getElementById(id);
const startScreen=$('startScreen'), startBtnBig=$('startBtnBig');
const placeBtn=$('placeBtn'), captureBtn=$('captureBtn');
const toast=$('toast'), reticle=$('reticle');
const orientationInd=$('orientationIndicator');

// í˜„ì¬ ë°©í–¥ ì¶”ì 
let currentOrientation='portrait'; // 'portrait' or 'landscape'

function showToast(msg){
  toast.textContent=msg;
  toast.style.display='block';
  setTimeout(()=>toast.style.display='none',2500);
}

// ë°©í–¥ ê°ì§€ ë° ì—…ë°ì´íŠ¸
function updateOrientation(){
  const w=window.innerWidth;
  const h=window.innerHeight;
  const isLandscape=w>h;
  
  const newOrientation=isLandscape?'landscape':'portrait';
  
  if(newOrientation!==currentOrientation){
    currentOrientation=newOrientation;
    document.body.className=currentOrientation;
    
    // AR ì„¸ì…˜ ì¤‘ì¼ ë•Œë§Œ í‘œì‹œ
    if(renderer && renderer.xr.isPresenting){
      orientationInd.textContent=isLandscape?'ğŸ“± ê°€ë¡œ ëª¨ë“œ (16:9)':'ğŸ“± ì„¸ë¡œ ëª¨ë“œ (9:16)';
      orientationInd.classList.add('show');
      setTimeout(()=>orientationInd.classList.remove('show'),2000);
    }
    
    console.log(`Orientation changed to: ${currentOrientation} (${w}x${h})`);
  }
  
  // ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸
  if(camera){
    camera.aspect=w/h;
    camera.updateProjectionMatrix();
  }
  
  // ë Œë”ëŸ¬ ì—…ë°ì´íŠ¸
  if(renderer){
    renderer.setSize(w,h);
  }
}

// ì´ˆê¸° ë°©í–¥ ì„¤ì •
updateOrientation();

// ë°©í–¥ ë³€ê²½ ê°ì§€ (ì—¬ëŸ¬ ì´ë²¤íŠ¸ ëª¨ë‹ˆí„°ë§)
window.addEventListener('resize',updateOrientation);
window.addEventListener('orientationchange',()=>{
  setTimeout(updateOrientation,100);
});

// Screen Orientation API ì‚¬ìš© ê°€ëŠ¥ì‹œ
if(screen.orientation){
  screen.orientation.addEventListener('change',()=>{
    setTimeout(updateOrientation,100);
  });
}

// Three.js ì´ˆê¸°í™” - alpha:falseë¡œ ì¹´ë©”ë¼ ë°°ê²½ ë³´ì´ë„ë¡
let renderer,scene,camera,dir;
try{
  renderer=new THREE.WebGLRenderer({
    antialias:true,
    alpha:false, // ì¹´ë©”ë¼ í”¼ë“œê°€ ë³´ì´ë„ë¡ falseë¡œ ì„¤ì •
    preserveDrawingBuffer:true
  });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.xr.enabled=true;
  document.body.appendChild(renderer.domElement);
  
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.01,100);
  
  scene.add(new THREE.HemisphereLight(0xffffff,0x888888,1.2));
  dir=new THREE.DirectionalLight(0xffffff,1.5);
  dir.position.set(0.5,1,0.3);
  scene.add(dir);
  scene.add(new THREE.AmbientLight(0xffffff,0.5));
}catch(e){
  alert('ì´ˆê¸°í™” ì‹¤íŒ¨: '+e.message);
  throw e;
}

// ê°„ë‹¨í•œ ëª¨ë¸
const placed=[];
function createSimpleModel(){
  const group=new THREE.Group();
  const box=new THREE.Mesh(
    new THREE.BoxGeometry(1,0.6,0.05),
    new THREE.MeshStandardMaterial({color:0x111111,roughness:0.5,metalness:0.4})
  );
  box.position.y=0.3;
  group.add(box);
  
  const screen=new THREE.Mesh(
    new THREE.PlaneGeometry(0.95,0.55),
    new THREE.MeshStandardMaterial({color:0x3333ff,emissive:0x111144,emissiveIntensity:0.5})
  );
  screen.position.set(0,0.3,0.026);
  group.add(screen);
  
  return group;
}

// Hit-test
let hitSource=null,lastHitPose=null;

renderer.setAnimationLoop((_,frame)=>{
  if(frame){
    const ref=renderer.xr.getReferenceSpace();
    const session=renderer.xr.getSession();
    
    if(!hitSource && session){
      session.requestReferenceSpace('viewer').then(view=>{
        session.requestHitTestSource({space:view}).then(src=>hitSource=src);
      });
      
      session.addEventListener('end',()=>{
        hitSource=null;
        startScreen.classList.remove('hidden');
        renderer.domElement.classList.remove('ar-active');
        $('fabContainer').style.display='none';
        reticle.style.opacity='0';
        orientationInd.classList.remove('show');
      });
    }
    
    if(hitSource){
      const hits=frame.getHitTestResults(hitSource);
      if(hits.length){
        lastHitPose=hits[0].getPose(ref);
        reticle.style.opacity='1';
      }else{
        lastHitPose=null;
        reticle.style.opacity='0';
      }
    }
  }
  renderer.render(scene,camera);
});

// ë°°ì¹˜
placeBtn.onclick=()=>{
  if(!lastHitPose){showToast('ë°”ë‹¥ì„ ì¸ì‹í•´ì£¼ì„¸ìš”');return;}
  
  const model=createSimpleModel();
  const m=new THREE.Matrix4().fromArray(lastHitPose.transform.matrix);
  const pos=new THREE.Vector3().setFromMatrixPosition(m);
  model.position.copy(pos);
  
  scene.add(model);
  placed.push(model);
  showToast(`âœ… ëª¨ë¸ ë°°ì¹˜ë¨ (${placed.length}ê°œ)`);
};

// ìŠ¤í¬ë¦°ìƒ· - ë°©í–¥ì— ë”°ë¼ ë¹„ìœ¨ ì¡°ì •
captureBtn.onclick=async ()=>{
  if(!placed.length){showToast('ëª¨ë¸ì„ ë¨¼ì € ë°°ì¹˜í•˜ì„¸ìš”');return;}
  
  const isLandscape=currentOrientation==='landscape';
  showToast(isLandscape?'ğŸ“¸ ê°€ë¡œ ëª¨ë“œë¡œ ì´¬ì˜ì¤‘...':'ğŸ“¸ ì„¸ë¡œ ëª¨ë“œë¡œ ì´¬ì˜ì¤‘...');
  
  await new Promise(r=>setTimeout(r,100));
  
  try{
    const canvas=renderer.domElement;
    const gl=canvas.getContext('webgl2')||canvas.getContext('webgl');
    
    renderer.render(scene,camera);
    
    const sourceW=canvas.width;
    const sourceH=canvas.height;
    
    // ì›ë³¸ í”½ì…€ ì½ê¸°
    const pixels=new Uint8Array(sourceW*sourceH*4);
    gl.readPixels(0,0,sourceW,sourceH,gl.RGBA,gl.UNSIGNED_BYTE,pixels);
    
    // ëª©í‘œ ë¹„ìœ¨ ê³„ì‚°
    let targetW,targetH;
    if(isLandscape){
      // ê°€ë¡œ ëª¨ë“œ: 16:9
      const ratio=16/9;
      if(sourceW/sourceH>ratio){
        // ë„ˆë¹„ê°€ ë” ë„“ìŒ - ë†’ì´ ê¸°ì¤€
        targetH=sourceH;
        targetW=Math.round(sourceH*ratio);
      }else{
        // ë†’ì´ê°€ ë” í¼ - ë„ˆë¹„ ê¸°ì¤€
        targetW=sourceW;
        targetH=Math.round(sourceW/ratio);
      }
    }else{
      // ì„¸ë¡œ ëª¨ë“œ: 9:16
      const ratio=9/16;
      if(sourceW/sourceH>ratio){
        // ë„ˆë¹„ê°€ ë” ë„“ìŒ - ë†’ì´ ê¸°ì¤€
        targetH=sourceH;
        targetW=Math.round(sourceH*ratio);
      }else{
        // ë†’ì´ê°€ ë” í¼ - ë„ˆë¹„ ê¸°ì¤€
        targetW=sourceW;
        targetH=Math.round(sourceW/ratio);
      }
    }
    
    // í¬ë¡­ ì˜ì—­ ê³„ì‚° (ì¤‘ì•™)
    const cropX=Math.floor((sourceW-targetW)/2);
    const cropY=Math.floor((sourceH-targetH)/2);
    
    console.log(`Capture: source=${sourceW}x${sourceH}, target=${targetW}x${targetH}, crop=(${cropX},${cropY})`);
    
    // ìº”ë²„ìŠ¤ ìƒì„±
    const cap=document.createElement('canvas');
    cap.width=targetW;
    cap.height=targetH;
    const ctx=cap.getContext('2d');
    const imgData=ctx.createImageData(targetW,targetH);
    
    // í”½ì…€ ë³µì‚¬ (ìƒí•˜ ë°˜ì „ + í¬ë¡­)
    for(let y=0;y<targetH;y++){
      for(let x=0;x<targetW;x++){
        const srcX=cropX+x;
        const srcY=cropY+y;
        const src=(srcY*sourceW+srcX)*4;
        const dst=((targetH-1-y)*targetW+x)*4;
        
        imgData.data[dst]=pixels[src];
        imgData.data[dst+1]=pixels[src+1];
        imgData.data[dst+2]=pixels[src+2];
        imgData.data[dst+3]=255;
      }
    }
    
    ctx.putImageData(imgData,0,0);
    const dataUrl=cap.toDataURL('image/jpeg',0.95);
    
    const a=document.createElement('a');
    const mode=isLandscape?'16x9':'9x16';
    a.href=dataUrl;
    a.download=`DID_AR_${mode}_${Date.now()}.jpg`;
    a.click();
    
    showToast(`âœ… ${mode} ë¹„ìœ¨ë¡œ ì €ì¥ë¨!`);
  }catch(e){
    console.error('Capture error:',e);
    showToast('âŒ ì‹¤íŒ¨: '+e.message);
  }
};

// AR ì‹œì‘
startBtnBig.onclick=()=>{
  if(!('xr' in navigator)||!self.isSecureContext){
    alert('WebXRì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Chrome/Edge ì‚¬ìš© ë° HTTPS í•„ìš”');
    return;
  }
  
  navigator.xr.isSessionSupported('immersive-ar').then(ok=>{
    if(!ok){alert('ARì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤');return;}
    
    const arBtn=ARButton.createButton(renderer,{requiredFeatures:['hit-test']});
    arBtn.style.display='none';
    document.body.appendChild(arBtn);
    arBtn.click();
    
    setTimeout(()=>{
      if(renderer.xr.isPresenting){
        startScreen.classList.add('hidden');
        renderer.domElement.classList.add('ar-active');
        $('fabContainer').style.display='flex';
        
        // í˜„ì¬ ë°©í–¥ í‘œì‹œ
        const isLandscape=currentOrientation==='landscape';
        orientationInd.textContent=isLandscape?'ğŸ“± ê°€ë¡œ ëª¨ë“œ (16:9)':'ğŸ“± ì„¸ë¡œ ëª¨ë“œ (9:16)';
        orientationInd.classList.add('show');
        setTimeout(()=>orientationInd.classList.remove('show'),3000);
        
        showToast('AR ì‹œì‘! í•¸ë“œí°ì„ ëŒë ¤ë³´ì„¸ìš”');
      }
    },1000);
  });
};
</script>
</body>
</html>
