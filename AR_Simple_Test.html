<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>AR Simple Test</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;overflow:hidden;background:#000;font-family:system-ui,-apple-system,sans-serif;color:#fff}
  
  #container{
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    padding:20px;text-align:center;height:100%;
  }
  
  #status{
    font-size:18px;margin-bottom:20px;padding:15px;background:rgba(255,255,255,0.1);
    border-radius:10px;width:90%;max-width:400px;
  }
  
  button{
    background:#0ea5e9;color:#fff;border:none;border-radius:12px;
    padding:20px 40px;font-size:18px;font-weight:700;cursor:pointer;
    margin:10px;min-width:200px;touch-action:manipulation;
    -webkit-tap-highlight-color:transparent;
  }
  button:active{transform:scale(0.95);background:#0284c7}
  button:disabled{background:#666;cursor:not-allowed}
  
  #log{
    margin-top:20px;padding:15px;background:rgba(0,255,0,0.1);
    border-radius:10px;width:90%;max-width:500px;max-height:300px;
    overflow-y:auto;font-size:12px;font-family:monospace;text-align:left;
  }
  .log-line{margin:3px 0;color:#0f0}
  .log-error{color:#f00}
  .log-success{color:#0ff}
  
  canvas{position:fixed;inset:0;display:none}
  canvas.active{display:block}
</style>
</head>
<body>

<div id="container">
  <h1 style="font-size:32px;margin-bottom:20px">ğŸ” AR í…ŒìŠ¤íŠ¸</h1>
  <div id="status">ì¤€ë¹„ ì¤‘...</div>
  <button id="checkBtn">1ï¸âƒ£ AR ì§€ì› í™•ì¸</button>
  <button id="startBtn" disabled>2ï¸âƒ£ AR ì„¸ì…˜ ì‹œì‘</button>
  <div id="log"></div>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

const $=id=>document.getElementById(id);
const status=$('status');
const checkBtn=$('checkBtn');
const startBtn=$('startBtn');
const logDiv=$('log');

let logCount=0;
function log(msg,type='info'){
  logCount++;
  const line=document.createElement('div');
  line.className=`log-line ${type==='error'?'log-error':type==='success'?'log-success':''}`;
  line.textContent=`[${logCount}] ${new Date().toLocaleTimeString()} - ${msg}`;
  logDiv.appendChild(line);
  logDiv.scrollTop=logDiv.scrollHeight;
  console.log(msg);
}

function setStatus(msg){
  status.textContent=msg;
  log(msg,'success');
}

// Three.js ì´ˆê¸°í™”
let renderer,scene,camera;
try{
  log('Three.js ì´ˆê¸°í™” ì‹œì‘...');
  renderer=new THREE.WebGLRenderer({antialias:true,alpha:false});
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.xr.enabled=true;
  document.body.appendChild(renderer.domElement);
  
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.01,100);
  
  const light=new THREE.HemisphereLight(0xffffff,0x444444,1);
  scene.add(light);
  
  // ê°„ë‹¨í•œ íë¸Œ
  const geometry=new THREE.BoxGeometry(0.2,0.2,0.2);
  const material=new THREE.MeshBasicMaterial({color:0x00ff00});
  const cube=new THREE.Mesh(geometry,material);
  cube.position.set(0,0,-1);
  scene.add(cube);
  
  renderer.setAnimationLoop(()=>{
    renderer.render(scene,camera);
  });
  
  log('Three.js ì´ˆê¸°í™” ì™„ë£Œ','success');
  setStatus('Three.js ì¤€ë¹„ ì™„ë£Œ âœ…');
}catch(e){
  log('Three.js ì´ˆê¸°í™” ì‹¤íŒ¨: '+e.message,'error');
  setStatus('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨');
}

// 1ë‹¨ê³„: AR ì§€ì› í™•ì¸
checkBtn.onclick=async function(){
  checkBtn.disabled=true;
  log('=== AR ì§€ì› ì²´í¬ ì‹œì‘ ===');
  
  try{
    // HTTPS ì²´í¬
    log(`í”„ë¡œí† ì½œ: ${window.location.protocol}`);
    if(!self.isSecureContext){
      throw new Error('HTTPS ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤');
    }
    log('âœ… HTTPS í™•ì¸','success');
    
    // WebXR ì²´í¬
    if(!('xr' in navigator)){
      throw new Error('navigator.xrì´ ì—†ìŠµë‹ˆë‹¤ (WebXR ë¯¸ì§€ì›)');
    }
    log('âœ… navigator.xr ì¡´ì¬','success');
    
    // ë¸Œë¼ìš°ì € ì •ë³´
    log(`User Agent: ${navigator.userAgent}`);
    
    // AR ì§€ì› ì²´í¬
    log('immersive-ar ì§€ì› ì²´í¬ ì¤‘...');
    const supported=await navigator.xr.isSessionSupported('immersive-ar');
    log(`ê²°ê³¼: ${supported}`);
    
    if(!supported){
      throw new Error('ì´ ê¸°ê¸°/ë¸Œë¼ìš°ì €ëŠ” ARì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
    }
    
    log('âœ… AR ì§€ì› í™•ì¸ ì™„ë£Œ!','success');
    setStatus('âœ… AR ì§€ì›ë¨! ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰ ê°€ëŠ¥');
    startBtn.disabled=false;
    
  }catch(e){
    log('âŒ ì˜¤ë¥˜: '+e.message,'error');
    setStatus('âŒ '+e.message);
    
    // í•´ê²° ë°©ë²• ì œì•ˆ
    if(!self.isSecureContext){
      log('ğŸ’¡ í•´ê²°ë°©ë²•: HTTPS ì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”','success');
    }
    if(!('xr' in navigator)){
      log('ğŸ’¡ í•´ê²°ë°©ë²•: Chrome ë˜ëŠ” Edge ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”','success');
    }
  }
};

// 2ë‹¨ê³„: AR ì„¸ì…˜ ì‹œì‘
startBtn.onclick=async function(){
  startBtn.disabled=true;
  log('=== AR ì„¸ì…˜ ì‹œì‘ ===');
  
  try{
    log('AR ì„¸ì…˜ ìš”ì²­ ì¤‘...');
    
    const session=await navigator.xr.requestSession('immersive-ar',{
      requiredFeatures:['hit-test'],
      optionalFeatures:['dom-overlay'],
      domOverlay:$('container')?{root:$('container')}:undefined
    });
    
    log('âœ… AR ì„¸ì…˜ ìƒì„±ë¨!','success');
    
    await renderer.xr.setSession(session);
    log('âœ… ë Œë”ëŸ¬ì— ì„¸ì…˜ ì„¤ì • ì™„ë£Œ','success');
    
    renderer.domElement.classList.add('active');
    $('container').style.display='none';
    
    setStatus('ğŸ‰ AR ì‹¤í–‰ ì¤‘!');
    log('AR ì„¸ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!','success');
    
    session.addEventListener('end',()=>{
      log('AR ì„¸ì…˜ ì¢…ë£Œ');
      renderer.domElement.classList.remove('active');
      $('container').style.display='flex';
      startBtn.disabled=false;
      setStatus('AR ì„¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
    });
    
  }catch(e){
    log('âŒ AR ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨: '+e.message,'error');
    log('ì—ëŸ¬ ì´ë¦„: '+e.name,'error');
    setStatus('âŒ AR ì‹œì‘ ì‹¤íŒ¨');
    startBtn.disabled=false;
    
    // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ í•´ê²° ë°©ë²•
    if(e.name==='NotAllowedError'){
      log('ğŸ’¡ ì‚¬ìš©ìê°€ ê¶Œí•œì„ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”','success');
    }else if(e.name==='NotSupportedError'){
      log('ğŸ’¡ í•„ìˆ˜ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤','success');
    }else if(e.name==='SecurityError'){
      log('ğŸ’¡ ë³´ì•ˆ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. HTTPSë¥¼ í™•ì¸í•˜ì„¸ìš”','success');
    }
  }
};

// ì´ˆê¸° ìƒíƒœ
log('ì•± ë¡œë“œ ì™„ë£Œ');
log('ë¸Œë¼ìš°ì €: '+navigator.userAgent);
setStatus('ì¤€ë¹„ ì™„ë£Œ - 1ë‹¨ê³„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”');
</script>
</body>
</html>
