<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>DID AR Enhanced â€¢ ì‹¤ì œ ì œí’ˆ ì‚¬ì–‘ ë°˜ì˜</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;overscroll-behavior:none;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR',sans-serif}
  canvas{position:fixed;inset:0;touch-action:none}
  
  /* ===== ìƒë‹¨ ì»¨íŠ¸ë¡¤ ===== */
  #topBar{
    position:fixed;top:0;left:0;right:0;z-index:20;
    background:linear-gradient(to bottom,rgba(0,0,0,.8),rgba(0,0,0,.5));
    padding:10px 12px;display:flex;flex-direction:column;gap:8px;
    box-shadow:0 2px 10px rgba(0,0,0,.3);
  }
  #topRow1{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  #topRow2{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  #topRow3{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  
  .btn{
    color:#fff;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.3);
    border-radius:8px;padding:7px 13px;font-size:13px;cursor:pointer;
    white-space:nowrap;user-select:none;transition:all 0.2s;
  }
  .btn:active{background:rgba(255,255,255,.25);transform:scale(0.98)}
  .btn.active{background:rgba(0,150,255,.55);border-color:rgba(0,180,255,.9);box-shadow:0 0 12px rgba(0,150,255,.4)}
  .btn.green{background:rgba(46,160,67,.65);border-color:rgba(46,160,67,1)}
  .btn.red{background:rgba(220,38,38,.65);border-color:rgba(220,38,38,1)}
  
  .group{display:flex;align-items:center;gap:6px;color:#fff;font-size:13px}
  input[type="range"]{width:120px;height:6px}
  input[type="checkbox"]{width:16px;height:16px}
  
  .divider{color:#666;margin:0 4px}
  
  /* ===== í•˜ë‹¨ ì¸ë„¤ì¼ íŠ¸ë ˆì´ ===== */
  #bottomTray{
    position:fixed;left:0;right:0;bottom:0;z-index:20;
    background:rgba(0,0,0,.8);border-top:1px solid rgba(255,255,255,.25);
    padding:10px 12px;display:flex;align-items:center;gap:10px;overflow-x:auto;
    box-shadow:0 -2px 10px rgba(0,0,0,.3);
  }
  #thumbs{display:flex;gap:8px}
  .thumb{
    width:72px;height:48px;flex:0 0 auto;border-radius:6px;
    border:2px solid rgba(255,255,255,.35);overflow:hidden;cursor:pointer;
    transition:all 0.2s;position:relative;
  }
  .thumb:hover{transform:scale(1.05)}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .thumb.active{border-color:#4fc3ff;box-shadow:0 0 0 2px rgba(79,195,255,.7) inset, 0 0 16px rgba(79,195,255,.5)}
  .thumb .remove{
    position:absolute;top:2px;right:2px;width:18px;height:18px;
    background:rgba(220,38,38,.9);border-radius:50%;
    color:#fff;font-size:12px;line-height:18px;text-align:center;
    display:none;cursor:pointer;
  }
  .thumb:hover .remove{display:block}
  
  #fileInput{display:none}
  #fileLabel{
    color:#fff;border:1px dashed rgba(255,255,255,.5);padding:7px 14px;
    border-radius:6px;cursor:pointer;font-size:13px;white-space:nowrap;
    transition:all 0.2s;
  }
  #fileLabel:hover{background:rgba(255,255,255,.1);border-color:#4fc3ff}
  
  /* ===== ì¤‘ì•™ ë¦¬í‹°í´(ë°°ì¹˜ ê°€ì´ë“œ) ===== */
  #reticle{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    width:80px;height:80px;border:3px solid #4fc3ff;border-radius:50%;
    pointer-events:none;z-index:15;display:none;opacity:0.7;
    box-shadow:0 0 20px rgba(79,195,255,0.5);
    animation:pulse 2s ease-in-out infinite;
  }
  @keyframes pulse{
    0%,100%{transform:translate(-50%,-50%) scale(1);opacity:0.7}
    50%{transform:translate(-50%,-50%) scale(1.1);opacity:0.9}
  }
  #reticle::after{
    content:'';position:absolute;top:50%;left:50%;
    width:6px;height:6px;background:#4fc3ff;border-radius:50%;
    transform:translate(-50%,-50%);
  }
  
  /* ===== FAB ë²„íŠ¼ë“¤ (ìš°ì¸¡ í•˜ë‹¨) ===== */
  #fabContainer{
    position:fixed;right:16px;bottom:120px;z-index:21;
    display:flex;flex-direction:column;gap:12px;align-items:flex-end;
  }
  .fab{
    padding:14px 20px;border-radius:12px;font-weight:600;
    border:none;box-shadow:0 4px 16px rgba(0,0,0,.5);
    color:#fff;cursor:pointer;font-size:14px;
    min-width:110px;text-align:center;transition:all 0.2s;
  }
  #startBtn{background:#2ea043}
  #placeBtn{background:#0ea5e9;display:none}
  #captureBtn{background:#f59e0b;display:none}
  .fab:active{transform:scale(0.95)}
  .fab:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.6)}
  
  /* ===== ì„ íƒëœ ê°ì²´ ì¡°ì‘ íŒ¨ë„ (ì¢Œì¸¡ í•˜ë‹¨) ===== */
  #editPanel{
    position:fixed;left:16px;bottom:120px;z-index:21;
    background:rgba(0,0,0,.9);border:1px solid rgba(255,255,255,.35);
    border-radius:12px;padding:14px;display:none;flex-direction:column;gap:12px;
    max-width:300px;box-shadow:0 4px 20px rgba(0,0,0,.6);
  }
  #editTitle{color:#4fc3ff;font-weight:600;font-size:15px;margin-bottom:4px}
  #editControls{display:flex;flex-direction:column;gap:10px}
  .editRow{display:flex;gap:6px;align-items:center;justify-content:space-between}
  .editLabel{color:#fff;font-size:13px;min-width:60px}
  
  /* ë°©í–¥ íŒ¨ë“œ */
  #dirPad{
    display:grid;grid-template-columns:repeat(3,38px);gap:4px;
    justify-self:center;
  }
  #dirPad button{
    width:38px;height:38px;border-radius:6px;
    border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.12);
    color:#fff;font-size:16px;cursor:pointer;transition:all 0.15s;
  }
  #dirPad button:active{background:rgba(255,255,255,.3);transform:scale(0.95)}
  #dirPad .center{grid-column:2;grid-row:2;font-size:10px;pointer-events:none;opacity:0.5}
  
  /* ===== í† ìŠ¤íŠ¸ ===== */
  #toast{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:rgba(0,0,0,.9);color:#fff;padding:14px 24px;
    border-radius:12px;z-index:50;display:none;font-size:14px;
    box-shadow:0 4px 24px rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.2);
    max-width:80%;text-align:center;
  }
  
  /* ===== ìº¡ì²˜ ì¸ë„¤ì¼ ìŠ¤íŠ¸ë¦½ ===== */
  #captureStrip{
    position:fixed;left:12px;bottom:240px;z-index:20;
    display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow-y:auto;
  }
  #captureStrip img{
    width:80px;height:60px;border-radius:6px;
    border:1px solid rgba(255,255,255,.35);object-fit:cover;
    box-shadow:0 2px 10px rgba(0,0,0,.5);cursor:pointer;
    transition:all 0.2s;
  }
  #captureStrip img:hover{transform:scale(1.05)}
  
  /* ===== ìƒíƒœ ì¸ë””ì¼€ì´í„° ===== */
  #statusBar{
    position:fixed;top:50%;left:50%;transform:translate(-50%,70px);
    color:#fff;font-size:14px;padding:10px 18px;
    background:rgba(0,0,0,.8);border-radius:10px;
    z-index:14;display:none;border:1px solid rgba(255,255,255,.25);
    box-shadow:0 4px 16px rgba(0,0,0,.5);
  }
  
  /* ===== ëª¨ë‹¬ (ì „ë©´ ì´ë¯¸ì§€ ì—…ë¡œë“œ) ===== */
  #frontImageModal{
    position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.85);
    display:none;justify-content:center;align-items:center;
  }
  #frontImageModal.show{display:flex}
  .modal-content{
    background:rgba(20,20,20,.95);border:1px solid rgba(255,255,255,.3);
    border-radius:16px;padding:24px;max-width:90%;max-height:80vh;
    overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.8);
  }
  .modal-title{color:#4fc3ff;font-size:18px;font-weight:600;margin-bottom:16px}
  .modal-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:12px;margin-top:12px}
  .modal-thumb{
    width:100%;aspect-ratio:1;border-radius:8px;border:2px solid rgba(255,255,255,.3);
    overflow:hidden;cursor:pointer;transition:all 0.2s;position:relative;
  }
  .modal-thumb:hover{transform:scale(1.05);border-color:#4fc3ff}
  .modal-thumb img{width:100%;height:100%;object-fit:cover}
  .modal-thumb.active{border-color:#4fc3ff;box-shadow:0 0 0 2px rgba(79,195,255,.5) inset}
  .modal-buttons{display:flex;gap:12px;margin-top:20px;justify-content:flex-end}
  
  /* ===== WebXR ê¸°ë³¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (í•˜ë‹¨ ì¤‘ì•™) ===== */
  #VRButton{display:none !important}
  [style*="position: absolute"][style*="bottom: 20px"]{display:none !important}
  
  /* AR ì‹œì‘ ë²„íŠ¼ */
  #startBtn{background:#2ea043}
</style>
</head>
<body>

<!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” -->
<div id="topBar">
  <div id="topRow1">
    <button id="btnModeWall" class="btn active">ğŸ–¼ï¸ ë²½ê±¸ì´í˜• (55")</button>
    <button id="btnModeTotem" class="btn">ğŸ›ï¸ ìŠ¤íƒ ë“œ (1900mm)</button>
    <span class="divider">|</span>
    <button id="btnBlack" class="btn active">â¬› ë¸”ë™</button>
    <button id="btnWhite" class="btn">â¬œ í™”ì´íŠ¸</button>
    <span class="divider">|</span>
    <button id="btnFrontImage" class="btn">ğŸ–¼ï¸ ì „ë©´ ì‚¬ì§„</button>
  </div>
  <div id="topRow2">
    <div class="group">
      <input type="checkbox" id="lockScale" checked/>
      <label for="lockScale">ğŸ”’ ì‹¤ì¸¡ ê³ ì •</label>
    </div>
    <div class="group">
      ğŸ“ ìŠ¤ì¼€ì¼ <input id="scaleRange" type="range" min="50" max="150" value="100" disabled/>
      <span id="scaleVal">100%</span>
    </div>
  </div>
  <div id="topRow3">
    <div class="group">
      ğŸ“ ë†’ì´ <input id="heightRange" type="range" min="-1000" max="2500" value="0"/>
      <span id="heightVal">0mm</span>
    </div>
    <div class="group">
      <input type="checkbox" id="showBezel" checked/>
      <label for="showBezel">ë² ì ¤ í‘œì‹œ</label>
    </div>
    <button id="clearAll" class="btn red">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
  </div>
</div>

<!-- í•˜ë‹¨ ì¸ë„¤ì¼ íŠ¸ë ˆì´ -->
<div id="bottomTray">
  <div id="thumbs"></div>
  <label id="fileLabel" for="fileInput">ğŸ“· í™”ë©´ ì´ë¯¸ì§€ ì¶”ê°€</label>
  <input id="fileInput" type="file" accept="image/*" multiple/>
</div>

<!-- ì¤‘ì•™ ë¦¬í‹°í´ (ë°°ì¹˜ ëª¨ë“œ ì‹œ) -->
<div id="reticle"></div>
<div id="statusBar">ë°”ë‹¥ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”</div>

<!-- FAB ë²„íŠ¼ë“¤ -->
<div id="fabContainer">
  <button id="startBtn" class="fab">ğŸš€ AR ì‹œì‘</button>
  <button id="placeBtn" class="fab">ğŸ“ ë°°ì¹˜í•˜ê¸°</button>
  <button id="captureBtn" class="fab">ğŸ“¸ ìº¡ì²˜</button>
</div>

<!-- ì„ íƒëœ ê°ì²´ í¸ì§‘ íŒ¨ë„ -->
<div id="editPanel">
  <div id="editTitle">ğŸ¯ ì„ íƒëœ ëª¨ë¸ ì¡°ì‘</div>
  <div id="editControls">
    <!-- ì´ë™ íŒ¨ë“œ -->
    <div class="editRow">
      <span class="editLabel">ì´ë™</span>
      <div id="dirPad">
        <button id="padUp">â–²</button>
        <button id="padLeft">â—„</button>
        <div class="center">ì´ë™</div>
        <button id="padRight">â–º</button>
        <button id="padDown">â–¼</button>
      </div>
    </div>
    
    <!-- íšŒì „ -->
    <div class="editRow">
      <span class="editLabel">íšŒì „</span>
      <div style="display:flex;gap:8px">
        <button class="btn" id="rotLeft">âŸ² 15Â°</button>
        <button class="btn" id="rotRight">âŸ³ 15Â°</button>
      </div>
    </div>
    
    <!-- ë†’ì´ ì¡°ì ˆ -->
    <div class="editRow">
      <span class="editLabel">ë†’ì´</span>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="heightDown">â–¼</button>
        <span id="objHeight" style="color:#fff;min-width:60px;text-align:center">0mm</span>
        <button class="btn" id="heightUp">â–²</button>
      </div>
    </div>
    
    <!-- ì‚­ì œ -->
    <div class="editRow">
      <button class="btn red" id="deleteBtn" style="flex:1">ğŸ—‘ï¸ ì‚­ì œ</button>
      <button class="btn green" id="deselectBtn" style="flex:1">âœ“ ì™„ë£Œ</button>
    </div>
  </div>
</div>

<!-- ìº¡ì²˜ ì´ë¯¸ì§€ ìŠ¤íŠ¸ë¦½ -->
<div id="captureStrip"></div>

<!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
<div id="toast"></div>

<!-- ì „ë©´ ì´ë¯¸ì§€ ì„ íƒ ëª¨ë‹¬ -->
<div id="frontImageModal">
  <div class="modal-content">
    <div class="modal-title">ğŸ“· ì „ë©´ ì‚¬ì§„ ì„ íƒ</div>
    <div style="color:#bbb;font-size:13px;margin-bottom:12px">
      ì œí’ˆ ì „ë©´ì— í‘œì‹œí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì—…ë¡œë“œí•˜ì„¸ìš”
    </div>
    <label for="frontFileInput" class="btn" style="display:inline-block;margin-bottom:12px">
      ğŸ“ íŒŒì¼ì—ì„œ ì—…ë¡œë“œ
    </label>
    <input id="frontFileInput" type="file" accept="image/*" multiple style="display:none"/>
    <div id="frontImageGrid" class="modal-grid"></div>
    <div class="modal-buttons">
      <button class="btn red" id="closeFrontModal">ì·¨ì†Œ</button>
      <button class="btn green" id="applyFrontImage">ì ìš©</button>
    </div>
  </div>
</div>



<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

/* ==================== ê¸°ë³¸ ì„¤ì • ==================== */
const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true, preserveDrawingBuffer:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);

// ì¡°ëª… (ë” ì‚¬ì‹¤ì ìœ¼ë¡œ)
const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
scene.add(ambientLight);

const dirLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight1.position.set(2, 3, 1);
scene.add(dirLight1);

const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
dirLight2.position.set(-1, 2, -1);
scene.add(dirLight2);

/* ==================== ìƒíƒœ ê´€ë¦¬ ==================== */
let placedObjects = [];
let selectedObject = null;
let mode = 'wall';
let scaleFactor = 1.0;
let heightOffset = 0;
let currentScreenTexture = null;
let currentFrontTexture = null;
let bodyColor = 0x111111; // ë¸”ë™
let showBezel = true;

let isPlacementMode = false;
let moveStep = 0.05;
let rotStep = 15;

// ì „ë©´ ì´ë¯¸ì§€ ëª¨ë‹¬ìš©
let tempFrontTexture = null;
let frontImageUrls = [];

/* ==================== ì¬ì§ˆ ìƒì„± ==================== */
const loader = new THREE.TextureLoader();

// ë³¸ì²´ ì¬ì§ˆ (ë©”íƒˆë¦­í•œ ëŠë‚Œ)
function createBodyMaterial(color) {
  return new THREE.MeshStandardMaterial({
    color: color,
    roughness: 0.5,
    metalness: 0.4,
  });
}

// ë² ì ¤ ì¬ì§ˆ (ì•½ê°„ ë” ë°ì€ í…Œë‘ë¦¬)
function createBezelMaterial(color) {
  const bezelColor = new THREE.Color(color);
  bezelColor.multiplyScalar(1.1); // ì‚´ì§ ë°ê²Œ
  return new THREE.MeshStandardMaterial({
    color: bezelColor,
    roughness: 0.6,
    metalness: 0.3,
  });
}

// í™”ë©´ ì¬ì§ˆ
function createScreenMaterial(texture) {
  return new THREE.MeshStandardMaterial({
    map: texture,
    roughness: 0.3,
    metalness: 0.05,
    emissive: 0x181818,
    emissiveIntensity: 0.4,
  });
}

// ì „ë©´ ì‚¬ì§„ ì¬ì§ˆ (ë² ì ¤ ìœ„ì— ì˜¤ë²„ë ˆì´) - ìˆ˜ì •: ë” ì„ ëª…í•˜ê²Œ
function createFrontMaterial(texture) {
  return new THREE.MeshBasicMaterial({
    map: texture,
    transparent: true,
    opacity: 1.0, // ì™„ì „ ë¶ˆíˆ¬ëª…ìœ¼ë¡œ ë³€ê²½
    side: THREE.DoubleSide,
  });
}

// ì´ˆê¸° í™”ë©´ í…ìŠ¤ì²˜
currentScreenTexture = loader.load('https://picsum.photos/1920/1080?random=default');
currentScreenTexture.colorSpace = THREE.SRGBColorSpace;

/* ==================== ì‹¤ì¸¡ ê¸°ë°˜ ëª¨ë¸ ìƒì„± ==================== */

// ë²½ê±¸ì´í˜• 55ì¸ì¹˜ (ì‹¤ì¸¡ ê¸°ì¤€)
function createWallModel() {
  const s = scaleFactor;
  const group = new THREE.Group();
  
  // ì‹¤ì œ 55ì¸ì¹˜ ë””ìŠ¤í”Œë ˆì´ í¬ê¸° (ëŒ€ëµ)
  const totalW = 1.230 * s; // ì „ì²´ ê°€ë¡œ
  const totalH = 0.690 * s; // ì „ì²´ ì„¸ë¡œ
  const totalD = 0.050 * s; // ì „ì²´ ê¹Šì´
  
  const bezelSize = 0.010 * s; // ë² ì ¤ ë‘ê»˜ 1cm
  const screenW = totalW - bezelSize * 2;
  const screenH = totalH - bezelSize * 2;
  
  // ë³¸ì²´
  const bodyMat = createBodyMaterial(bodyColor);
  const body = new THREE.Mesh(
    new THREE.BoxGeometry(totalW, totalH, totalD),
    bodyMat
  );
  body.position.y = totalH / 2;
  group.add(body);
  
  // ë² ì ¤ (ì•ë©´ í”„ë ˆì„)
  if (showBezel) {
    const bezelMat = createBezelMaterial(bodyColor);
    
    // ìƒë‹¨ ë² ì ¤
    const bezelTop = new THREE.Mesh(
      new THREE.BoxGeometry(totalW, bezelSize, 0.001),
      bezelMat
    );
    bezelTop.position.set(0, totalH - bezelSize/2, totalD/2 + 0.001);
    group.add(bezelTop);
    
    // í•˜ë‹¨ ë² ì ¤
    const bezelBottom = new THREE.Mesh(
      new THREE.BoxGeometry(totalW, bezelSize, 0.001),
      bezelMat
    );
    bezelBottom.position.set(0, bezelSize/2, totalD/2 + 0.001);
    group.add(bezelBottom);
    
    // ì¢Œì¸¡ ë² ì ¤
    const bezelLeft = new THREE.Mesh(
      new THREE.BoxGeometry(bezelSize, screenH, 0.001),
      bezelMat
    );
    bezelLeft.position.set(-totalW/2 + bezelSize/2, totalH/2, totalD/2 + 0.001);
    group.add(bezelLeft);
    
    // ìš°ì¸¡ ë² ì ¤
    const bezelRight = new THREE.Mesh(
      new THREE.BoxGeometry(bezelSize, screenH, 0.001),
      bezelMat
    );
    bezelRight.position.set(totalW/2 - bezelSize/2, totalH/2, totalD/2 + 0.001);
    group.add(bezelRight);
  }
  
  // í™”ë©´
  const screen = new THREE.Mesh(
    new THREE.PlaneGeometry(screenW, screenH),
    createScreenMaterial(currentScreenTexture)
  );
  screen.position.set(0, totalH/2, totalD/2 + 0.0025);
  group.add(screen);
  
  // ì „ë©´ ì‚¬ì§„ ì˜¤ë²„ë ˆì´ (ì˜µì…˜) - ìˆ˜ì •: ë” ì•ìª½ì— ë°°ì¹˜
  if (currentFrontTexture) {
    const frontOverlay = new THREE.Mesh(
      new THREE.PlaneGeometry(totalW * 0.98, totalH * 0.98), // ì‚´ì§ ì‘ê²Œ
      createFrontMaterial(currentFrontTexture)
    );
    frontOverlay.position.set(0, totalH/2, totalD/2 + 0.006); // ë” ì•ìœ¼ë¡œ
    group.add(frontOverlay);
    group.userData.frontOverlay = frontOverlay;
  }
  
  group.userData.type = 'wall';
  group.userData.screenMesh = screen;
  group.userData.bodyMesh = body;
  group.userData.dimensions = { w: totalW, h: totalH, d: totalD };
  
  return group;
}

// ìŠ¤íƒ ë“œí˜• 1900mm (ì‹¤ì¸¡ ê¸°ì¤€)
function createTotemModel() {
  const s = scaleFactor;
  const group = new THREE.Group();
  
  // ì‹¤ì œ ìŠ¤íƒ ë“œí˜• ì‚¬ì´ì¦ˆ
  const displayW = 0.740 * s;
  const displayH = 1.900 * s;
  const displayD = 0.120 * s;
  
  const baseW = displayW * 1.2;
  const baseH = 0.050 * s;
  const baseD = 0.500 * s;
  
  const bezelSize = 0.015 * s; // ë² ì ¤ 1.5cm
  const screenW = displayW - bezelSize * 2;
  const screenH = displayH * 0.75; // í™”ë©´ ë¹„ìœ¨
  
  // ë² ì´ìŠ¤
  const bodyMat = createBodyMaterial(bodyColor);
  const base = new THREE.Mesh(
    new THREE.BoxGeometry(baseW, baseH, baseD),
    bodyMat
  );
  base.position.y = baseH / 2;
  group.add(base);
  
  // ë³¸ì²´
  const body = new THREE.Mesh(
    new THREE.BoxGeometry(displayW, displayH, displayD),
    bodyMat
  );
  body.position.y = baseH + displayH / 2;
  group.add(body);
  
  // ë² ì ¤
  if (showBezel) {
    const bezelMat = createBezelMaterial(bodyColor);
    const bezelY = baseH + displayH * 0.55;
    
    // ìƒë‹¨ ë² ì ¤
    const bezelTop = new THREE.Mesh(
      new THREE.BoxGeometry(displayW, bezelSize, 0.001),
      bezelMat
    );
    bezelTop.position.set(0, bezelY + screenH/2 + bezelSize/2, displayD/2 + 0.001);
    group.add(bezelTop);
    
    // í•˜ë‹¨ ë² ì ¤
    const bezelBottom = new THREE.Mesh(
      new THREE.BoxGeometry(displayW, bezelSize, 0.001),
      bezelMat
    );
    bezelBottom.position.set(0, bezelY - screenH/2 - bezelSize/2, displayD/2 + 0.001);
    group.add(bezelBottom);
    
    // ì¢Œì¸¡ ë² ì ¤
    const bezelLeft = new THREE.Mesh(
      new THREE.BoxGeometry(bezelSize, screenH, 0.001),
      bezelMat
    );
    bezelLeft.position.set(-displayW/2 + bezelSize/2, bezelY, displayD/2 + 0.001);
    group.add(bezelLeft);
    
    // ìš°ì¸¡ ë² ì ¤
    const bezelRight = new THREE.Mesh(
      new THREE.BoxGeometry(bezelSize, screenH, 0.001),
      bezelMat
    );
    bezelRight.position.set(displayW/2 - bezelSize/2, bezelY, displayD/2 + 0.001);
    group.add(bezelRight);
  }
  
  // í™”ë©´
  const screen = new THREE.Mesh(
    new THREE.PlaneGeometry(screenW, screenH),
    createScreenMaterial(currentScreenTexture)
  );
  screen.position.set(0, baseH + displayH * 0.55, displayD/2 + 0.0025);
  group.add(screen);
  
  // ì „ë©´ ì‚¬ì§„ ì˜¤ë²„ë ˆì´ - ìˆ˜ì •: ë” ì•ìª½ì— ë°°ì¹˜
  if (currentFrontTexture) {
    const frontOverlay = new THREE.Mesh(
      new THREE.PlaneGeometry(displayW * 0.98, displayH * 0.98), // ì‚´ì§ ì‘ê²Œ
      createFrontMaterial(currentFrontTexture)
    );
    frontOverlay.position.set(0, baseH + displayH/2, displayD/2 + 0.006); // ë” ì•ìœ¼ë¡œ
    group.add(frontOverlay);
    group.userData.frontOverlay = frontOverlay;
  }
  
  group.userData.type = 'totem';
  group.userData.screenMesh = screen;
  group.userData.bodyMesh = body;
  group.userData.dimensions = { w: displayW, h: displayH, d: displayD };
  
  return group;
}

/* ==================== ë¦¬í‹°í´ ==================== */
const reticleGroup = new THREE.Group();
reticleGroup.visible = false;
scene.add(reticleGroup);

const reticleFill = new THREE.Mesh(
  new THREE.CircleGeometry(0.3, 32).rotateX(-Math.PI / 2),
  new THREE.MeshBasicMaterial({ color: 0x4fc3ff, transparent: true, opacity: 0.2 })
);
const reticleRing = new THREE.Mesh(
  new THREE.RingGeometry(0.27, 0.3, 32).rotateX(-Math.PI / 2),
  new THREE.MeshBasicMaterial({ color: 0x4fc3ff, transparent: true, opacity: 0.9 })
);
reticleGroup.add(reticleFill);
reticleGroup.add(reticleRing);

/* ==================== XR Hit Test ==================== */
let hitTestSource = null;
let hitTestSourceRequested = false;
let lastHitPose = null;

renderer.xr.addEventListener('sessionstart', () => {
  console.log('âœ… XR ì„¸ì…˜ ì‹œì‘');
  $('startBtn').style.display = 'none';
  $('placeBtn').style.display = 'block';
  $('captureBtn').style.display = 'block';
  $('reticle').style.display = 'block';
  $('statusBar').style.display = 'block';
});

renderer.xr.addEventListener('sessionend', () => {
  console.log('âŒ XR ì„¸ì…˜ ì¢…ë£Œ');
  $('startBtn').style.display = 'block';
  $('placeBtn').style.display = 'none';
  $('captureBtn').style.display = 'none';
  $('reticle').style.display = 'none';
  $('statusBar').style.display = 'none';
  hitTestSourceRequested = false;
  hitTestSource = null;
  isPlacementMode = false;
});

/* ==================== ë Œë” ë£¨í”„ ==================== */
renderer.setAnimationLoop((timestamp, frame) => {
  if (frame) {
    const referenceSpace = renderer.xr.getReferenceSpace();
    const session = renderer.xr.getSession();
    
    if (!hitTestSourceRequested && session) {
      session.requestReferenceSpace('viewer').then((viewerSpace) => {
        session.requestHitTestSource({ space: viewerSpace }).then((source) => {
          hitTestSource = source;
        });
      });
      session.addEventListener('end', () => {
        hitTestSourceRequested = false;
        hitTestSource = null;
      });
      hitTestSourceRequested = true;
    }
    
    if (hitTestSource) {
      const hitTestResults = frame.getHitTestResults(hitTestSource);
      if (hitTestResults.length > 0) {
        const hit = hitTestResults[0];
        const pose = hit.getPose(referenceSpace);
        lastHitPose = pose;
        
        reticleGroup.visible = isPlacementMode;
        if (isPlacementMode) {
          const matrix = new THREE.Matrix4().fromArray(pose.transform.matrix);
          reticleGroup.position.setFromMatrixPosition(matrix);
          reticleGroup.quaternion.setFromRotationMatrix(matrix);
          $('statusBar').textContent = 'âœ“ ë°°ì¹˜ ê°€ëŠ¥ - [ë°°ì¹˜í•˜ê¸°] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”';
        }
      } else {
        reticleGroup.visible = false;
        if (isPlacementMode) {
          $('statusBar').textContent = 'ğŸ“± ë°”ë‹¥ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”';
        }
      }
    }
  }
  
  renderer.render(scene, camera);
});

/* ==================== ëª¨ë¸ ë°°ì¹˜ ==================== */
function placeModel(pose) {
  if (!pose) return;
  
  const model = (mode === 'wall') ? createWallModel() : createTotemModel();
  
  const matrix = new THREE.Matrix4().fromArray(pose.transform.matrix);
  const position = new THREE.Vector3().setFromMatrixPosition(matrix);
  const quaternion = new THREE.Quaternion().setFromRotationMatrix(matrix);
  
  model.position.set(
    position.x,
    position.y + (heightOffset / 1000),
    position.z
  );
  model.quaternion.copy(quaternion);
  
  model.userData.groundY = position.y;
  model.userData.currentHeightOffset = heightOffset;
  
  scene.add(model);
  placedObjects.push(model);
  
  showToast('âœ“ ëª¨ë¸ì´ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤');
  selectObject(model);
  isPlacementMode = false;
  $('placeBtn').classList.remove('active');
}

/* ==================== ê°ì²´ ì„ íƒ/í•´ì œ ==================== */
function selectObject(obj) {
  if (selectedObject) {
    deselectObject();
  }
  
  selectedObject = obj;
  $('editPanel').style.display = 'flex';
  updateEditPanel();
  
  // ì„ íƒ í‘œì‹œ
  obj.traverse((child) => {
    if (child.isMesh && child.material) {
      child.userData.originalEmissive = child.material.emissive?.getHex() || 0;
      child.userData.originalEmissiveIntensity = child.material.emissiveIntensity || 0;
      if (child.material.emissive) {
        child.material.emissive.setHex(0x2080ff);
        child.material.emissiveIntensity = 0.3;
      }
    }
  });
}

function deselectObject() {
  if (selectedObject) {
    selectedObject.traverse((child) => {
      if (child.isMesh && child.userData.originalEmissive !== undefined) {
        if (child.material.emissive) {
          child.material.emissive.setHex(child.userData.originalEmissive);
          child.material.emissiveIntensity = child.userData.originalEmissiveIntensity || 0;
        }
      }
    });
  }
  
  selectedObject = null;
  $('editPanel').style.display = 'none';
}

function updateEditPanel() {
  if (!selectedObject) return;
  const currentHeight = selectedObject.userData.currentHeightOffset || 0;
  $('objHeight').textContent = currentHeight + 'mm';
}

/* ==================== ê°ì²´ ì¡°ì‘ ==================== */
function moveObject(dx, dz) {
  if (!selectedObject) return;
  selectedObject.position.x += dx;
  selectedObject.position.z += dz;
}

function rotateObject(angleDeg) {
  if (!selectedObject) return;
  selectedObject.rotation.y += THREE.MathUtils.degToRad(angleDeg);
}

function adjustHeight(deltaY) {
  if (!selectedObject) return;
  const newOffset = (selectedObject.userData.currentHeightOffset || 0) + deltaY;
  selectedObject.userData.currentHeightOffset = newOffset;
  const groundY = selectedObject.userData.groundY || selectedObject.position.y;
  selectedObject.position.y = groundY + (newOffset / 1000);
  updateEditPanel();
}

function deleteObject() {
  if (!selectedObject) return;
  scene.remove(selectedObject);
  const index = placedObjects.indexOf(selectedObject);
  if (index > -1) placedObjects.splice(index, 1);
  showToast('ğŸ—‘ï¸ ëª¨ë¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  deselectObject();
}

function rebuildSelectedModel() {
  if (!selectedObject) return;
  
  const type = selectedObject.userData.type || 'wall';
  const pos = selectedObject.position.clone();
  const quat = selectedObject.quaternion.clone();
  const groundY = selectedObject.userData.groundY || 0;
  const heightOff = selectedObject.userData.currentHeightOffset || 0;
  
  scene.remove(selectedObject);
  const index = placedObjects.indexOf(selectedObject);
  
  const newModel = (type === 'wall') ? createWallModel() : createTotemModel();
  newModel.position.copy(pos);
  newModel.quaternion.copy(quat);
  newModel.userData.groundY = groundY;
  newModel.userData.currentHeightOffset = heightOff;
  
  scene.add(newModel);
  if (index > -1) placedObjects[index] = newModel;
  
  selectedObject = newModel;
  selectObject(newModel);
}

/* ==================== UI í—¬í¼ ==================== */
const $ = (id) => document.getElementById(id);

function showToast(message, duration = 2000) {
  const toast = $('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, duration);
}

function setActive(btnId, group) {
  group.forEach(id => $(id).classList.remove('active'));
  $(btnId).classList.add('active');
}

/* ==================== ì¸ë„¤ì¼ ê´€ë¦¬ (í™”ë©´ ì´ë¯¸ì§€) ==================== */
function addScreenThumbnail(url, isDefault = false) {
  const thumb = document.createElement('div');
  thumb.className = 'thumb';
  if (isDefault) thumb.classList.add('active');
  
  const img = document.createElement('img');
  img.src = url;
  thumb.appendChild(img);
  
  const removeBtn = document.createElement('div');
  removeBtn.className = 'remove';
  removeBtn.textContent = 'Ã—';
  removeBtn.onclick = (e) => {
    e.stopPropagation();
    if (confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      thumb.remove();
      if (thumb.classList.contains('active')) {
        const firstThumb = $('thumbs').querySelector('.thumb');
        if (firstThumb) firstThumb.click();
      }
    }
  };
  thumb.appendChild(removeBtn);
  
  thumb.onclick = () => {
    document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
    thumb.classList.add('active');
    
    const newTexture = loader.load(url);
    newTexture.colorSpace = THREE.SRGBColorSpace;
    currentScreenTexture = newTexture;
    
    // ì„ íƒëœ ê°ì²´ì— ì¦‰ì‹œ ì ìš©
    if (selectedObject && selectedObject.userData.screenMesh) {
      selectedObject.userData.screenMesh.material = createScreenMaterial(newTexture);
    }
    
    showToast('ğŸ“º í™”ë©´ ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
  };
  
  $('thumbs').appendChild(thumb);
}

// ê¸°ë³¸ ì¸ë„¤ì¼
addScreenThumbnail('https://picsum.photos/1920/1080?random=1', true);
addScreenThumbnail('https://picsum.photos/1920/1080?random=2');
addScreenThumbnail('https://picsum.photos/1920/1080?random=3');

/* ==================== ì „ë©´ ì´ë¯¸ì§€ ê´€ë¦¬ ==================== */
function initFrontImageModal() {
  // ê¸°ë³¸ ìƒ˜í”Œ ì´ë¯¸ì§€ë“¤
  const samples = [
    'https://picsum.photos/800/1200?random=front1',
    'https://picsum.photos/800/1200?random=front2',
    'https://picsum.photos/800/1200?random=front3',
    'https://picsum.photos/800/1200?random=front4',
  ];
  
  frontImageUrls.push(...samples);
  renderFrontImageGrid();
}

function renderFrontImageGrid() {
  const grid = $('frontImageGrid');
  grid.innerHTML = '';
  
  // "ì—†ìŒ" ì˜µì…˜
  const noneThumb = document.createElement('div');
  noneThumb.className = 'modal-thumb';
  if (!tempFrontTexture) noneThumb.classList.add('active');
  noneThumb.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#333;color:#fff;font-size:12px">ì—†ìŒ</div>';
  noneThumb.onclick = () => {
    document.querySelectorAll('.modal-thumb').forEach(t => t.classList.remove('active'));
    noneThumb.classList.add('active');
    tempFrontTexture = null;
  };
  grid.appendChild(noneThumb);
  
  frontImageUrls.forEach((url, idx) => {
    const thumb = document.createElement('div');
    thumb.className = 'modal-thumb';
    
    const img = document.createElement('img');
    img.src = url;
    thumb.appendChild(img);
    
    thumb.onclick = () => {
      document.querySelectorAll('.modal-thumb').forEach(t => t.classList.remove('active'));
      thumb.classList.add('active');
      
      const tex = loader.load(url);
      tex.colorSpace = THREE.SRGBColorSpace;
      tempFrontTexture = tex;
    };
    
    grid.appendChild(thumb);
  });
}

$('btnFrontImage').onclick = () => {
  tempFrontTexture = currentFrontTexture;
  $('frontImageModal').classList.add('show');
  renderFrontImageGrid();
};

$('closeFrontModal').onclick = () => {
  $('frontImageModal').classList.remove('show');
};

$('applyFrontImage').onclick = () => {
  currentFrontTexture = tempFrontTexture;
  $('frontImageModal').classList.remove('show');
  
  // ì„ íƒëœ ê°ì²´ê°€ ìˆìœ¼ë©´ ì¬ìƒì„±
  if (selectedObject) {
    rebuildSelectedModel();
  }
  
  if (currentFrontTexture) {
    showToast('ğŸ–¼ï¸ ì „ë©´ ì‚¬ì§„ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤');
  } else {
    showToast('ğŸ–¼ï¸ ì „ë©´ ì‚¬ì§„ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
  }
};

$('frontFileInput').onchange = (e) => {
  const files = Array.from(e.target.files || []);
  files.forEach(file => {
    const url = URL.createObjectURL(file);
    frontImageUrls.push(url);
  });
  renderFrontImageGrid();
  if (files.length > 0) {
    showToast(`ğŸ“· ${files.length}ê°œì˜ ì „ë©´ ì‚¬ì§„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
  }
};

initFrontImageModal();

/* ==================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ==================== */

// ëª¨ë“œ ì„ íƒ
$('btnModeWall').onclick = () => {
  mode = 'wall';
  setActive('btnModeWall', ['btnModeWall', 'btnModeTotem']);
  showToast('ğŸ–¼ï¸ ë²½ê±¸ì´í˜• (55") ì„ íƒ');
};

$('btnModeTotem').onclick = () => {
  mode = 'totem';
  setActive('btnModeTotem', ['btnModeWall', 'btnModeTotem']);
  showToast('ğŸ›ï¸ ìŠ¤íƒ ë“œí˜• (1900mm) ì„ íƒ');
};

// ìƒ‰ìƒ ì„ íƒ
$('btnBlack').onclick = () => {
  bodyColor = 0x111111;
  setActive('btnBlack', ['btnBlack', 'btnWhite']);
  if (selectedObject) rebuildSelectedModel();
  showToast('â¬› ë¸”ë™ ì»¬ëŸ¬ ì ìš©');
};

$('btnWhite').onclick = () => {
  bodyColor = 0xf2f2f2;
  setActive('btnWhite', ['btnBlack', 'btnWhite']);
  if (selectedObject) rebuildSelectedModel();
  showToast('â¬œ í™”ì´íŠ¸ ì»¬ëŸ¬ ì ìš©');
};

// ìŠ¤ì¼€ì¼ ì ê¸ˆ
$('lockScale').onchange = () => {
  const locked = $('lockScale').checked;
  $('scaleRange').disabled = locked;
  if (locked) {
    scaleFactor = 1.0;
    $('scaleRange').value = 100;
    $('scaleVal').textContent = '100%';
  }
};

$('scaleRange').oninput = () => {
  const val = parseInt($('scaleRange').value);
  scaleFactor = val / 100;
  $('scaleVal').textContent = val + '%';
};

// ë†’ì´ ì˜¤í”„ì…‹
$('heightRange').oninput = () => {
  heightOffset = parseInt($('heightRange').value);
  $('heightVal').textContent = heightOffset + 'mm';
};

// ë² ì ¤ í‘œì‹œ í† ê¸€
$('showBezel').onchange = () => {
  showBezel = $('showBezel').checked;
  if (selectedObject) rebuildSelectedModel();
  showToast(showBezel ? 'âœ“ ë² ì ¤ í‘œì‹œ' : 'âœ— ë² ì ¤ ìˆ¨ê¹€');
};

// ì „ì²´ ì‚­ì œ
$('clearAll').onclick = () => {
  if (placedObjects.length === 0) {
    showToast('âš ï¸ ì‚­ì œí•  ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  if (confirm(`${placedObjects.length}ê°œì˜ ëª¨ë¸ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    placedObjects.forEach(obj => scene.remove(obj));
    placedObjects = [];
    deselectObject();
    showToast('ğŸ—‘ï¸ ëª¨ë“  ëª¨ë¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  }
};

// í™”ë©´ ì´ë¯¸ì§€ ì—…ë¡œë“œ
$('fileInput').onchange = (e) => {
  const files = Array.from(e.target.files || []);
  files.forEach((file, index) => {
    const url = URL.createObjectURL(file);
    addScreenThumbnail(url, index === 0 && $('thumbs').children.length === 0);
  });
  if (files.length > 0) {
    showToast(`ğŸ“· ${files.length}ê°œì˜ í™”ë©´ ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
  }
};

// AR ì‹œì‘ ë²„íŠ¼
let arButton = null;
$('startBtn').onclick = () => {
  if (!('xr' in navigator)) {
    alert('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” WebXRì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nâœ… AR Coreë¥¼ ì§€ì›í•˜ëŠ” Android ê¸°ê¸°ì—ì„œ\nChrome ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!arButton) {
    arButton = ARButton.createButton(renderer, {
      requiredFeatures: ['hit-test'],
      optionalFeatures: ['dom-overlay'],
      domOverlay: { root: document.body }
    });
    // WebXR ê¸°ë³¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    arButton.style.display = 'none';
    arButton.style.position = 'fixed';
    arButton.style.bottom = '-9999px';
    document.body.appendChild(arButton);
  }
  
  arButton.click();
};

// ë°°ì¹˜ ëª¨ë“œ
$('placeBtn').onclick = () => {
  isPlacementMode = !isPlacementMode;
  $('placeBtn').classList.toggle('active', isPlacementMode);
  
  if (isPlacementMode) {
    $('placeBtn').textContent = 'âœ“ ë°°ì¹˜ ì¤€ë¹„';
    showToast('ğŸ’¡ ë°”ë‹¥ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ì›€ì§ì´ê³ \n[ë°°ì¹˜í•˜ê¸°] ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆ„ë¥´ì„¸ìš”');
    deselectObject();
  } else {
    $('placeBtn').textContent = 'ğŸ“ ë°°ì¹˜í•˜ê¸°';
    
    if (lastHitPose) {
      placeModel(lastHitPose);
    }
  }
};

// ìº¡ì²˜ - JPGë¡œ ì €ì¥
$('captureBtn').onclick = async () => {
  if (placedObjects.length === 0) {
    showToast('âš ï¸ ë°°ì¹˜ëœ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  const uiElements = ['topBar', 'bottomTray', 'fabContainer', 'editPanel', 'reticle', 'statusBar', 'captureStrip'];
  uiElements.forEach(id => {
    const el = $(id);
    if (el) el.style.visibility = 'hidden';
  });
  
  await new Promise(requestAnimationFrame);
  
  try {
    // PNG ëŒ€ì‹  JPGë¡œ ìº¡ì²˜
    const dataUrl = renderer.domElement.toDataURL('image/jpeg', 0.95); // JPG, í’ˆì§ˆ 95%
    
    const a = document.createElement('a');
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    a.href = dataUrl;
    a.download = `DID_AR_${timestamp}.jpg`; // JPG í™•ì¥ì
    document.body.appendChild(a);
    a.click();
    a.remove();
    
    const img = document.createElement('img');
    img.src = dataUrl;
    img.onclick = () => {
      const win = window.open();
      win.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto"/>`);
    };
    $('captureStrip').prepend(img);
    
    if (navigator.canShare) {
      const response = await fetch(dataUrl);
      const blob = await response.blob();
      const file = new File([blob], `DID_AR_${timestamp}.jpg`, { type: 'image/jpeg' }); // JPG
      
      if (navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: 'DID AR Capture'
          });
        } catch (err) {
          console.log('ê³µìœ  ì·¨ì†Œ:', err);
        }
      }
    }
    
    showToast('ğŸ“¸ JPG ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  } catch (err) {
    showToast('âŒ ìº¡ì²˜ ì‹¤íŒ¨: ' + err.message);
  } finally {
    uiElements.forEach(id => {
      const el = $(id);
      if (el) el.style.visibility = 'visible';
    });
  }
};

// í¸ì§‘ íŒ¨ë„ - ì´ë™
function setupMoveButton(btnId, dx, dz) {
  let interval = null;
  const btn = $(btnId);
  
  const move = () => moveObject(dx * moveStep, dz * moveStep);
  
  const start = () => {
    move();
    interval = setInterval(move, 150);
  };
  
  const stop = () => {
    if (interval) {
      clearInterval(interval);
      interval = null;
    }
  };
  
  btn.addEventListener('touchstart', start, { passive: true });
  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchend', stop);
  btn.addEventListener('touchcancel', stop);
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);
}

setupMoveButton('padUp', 0, -1);
setupMoveButton('padDown', 0, 1);
setupMoveButton('padLeft', -1, 0);
setupMoveButton('padRight', 1, 0);

$('rotLeft').onclick = () => rotateObject(-rotStep);
$('rotRight').onclick = () => rotateObject(rotStep);

$('heightUp').onclick = () => adjustHeight(50);
$('heightDown').onclick = () => adjustHeight(-50);

$('deleteBtn').onclick = deleteObject;
$('deselectBtn').onclick = deselectObject;

/* ==================== í„°ì¹˜ ì œìŠ¤ì²˜ (íƒ­ìœ¼ë¡œ ì„ íƒ) ==================== */
const raycaster = new THREE.Raycaster();
let touchStartTime = 0;
let touchStartPos = { x: 0, y: 0 };

renderer.domElement.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1 && !isPlacementMode) {
    touchStartTime = Date.now();
    touchStartPos.x = e.touches[0].clientX;
    touchStartPos.y = e.touches[0].clientY;
  }
}, { passive: true });

renderer.domElement.addEventListener('touchend', (e) => {
  if (e.changedTouches.length === 1 && !isPlacementMode) {
    const touchEndTime = Date.now();
    const touchEndPos = {
      x: e.changedTouches[0].clientX,
      y: e.changedTouches[0].clientY
    };
    
    const timeDiff = touchEndTime - touchStartTime;
    const distance = Math.hypot(
      touchEndPos.x - touchStartPos.x,
      touchEndPos.y - touchStartPos.y
    );
    
    if (timeDiff < 300 && distance < 20) {
      trySelectObject(touchEndPos.x, touchEndPos.y);
    }
  }
});

function trySelectObject(clientX, clientY) {
  if (placedObjects.length === 0) return;
  
  const x = (clientX / window.innerWidth) * 2 - 1;
  const y = -(clientY / window.innerHeight) * 2 + 1;
  
  raycaster.setFromCamera({ x, y }, camera);
  
  const meshes = [];
  placedObjects.forEach(obj => {
    obj.traverse(child => {
      if (child.isMesh) meshes.push(child);
    });
  });
  
  const intersects = raycaster.intersectObjects(meshes, false);
  
  if (intersects.length > 0) {
    let target = intersects[0].object;
    
    while (target && !placedObjects.includes(target)) {
      target = target.parent;
    }
    
    if (target) {
      if (selectedObject === target) {
        deselectObject();
      } else {
        selectObject(target);
        showToast('âœ“ ëª¨ë¸ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }
  } else {
    deselectObject();
  }
}

/* ==================== ë¦¬ì‚¬ì´ì¦ˆ ==================== */
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

console.log('âœ… DID AR Enhanced (ì œí’ˆ ì‚¬ì–‘ ë°˜ì˜) ì´ˆê¸°í™” ì™„ë£Œ');
console.log('ğŸ“ ì‹¤ì¸¡ ê¸°ë°˜ ëª¨ë¸ / ğŸ¨ ìƒ‰ìƒ ì„ íƒ / ğŸ–¼ï¸ ì „ë©´ ì‚¬ì§„ / ğŸ“º í™”ë©´ ì´ë¯¸ì§€ / ğŸ“¸ JPG ìº¡ì²˜');
</script>
</body>
</html>
