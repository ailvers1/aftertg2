<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>DID AR Enhanced â€¢ ì¹´ë©”ë¼ ë·° + ê°œì„ ëœ ì¡°ì‘</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#000;overscroll-behavior:none;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR',sans-serif}
  canvas{position:fixed;inset:0;touch-action:none}
  
  /* ===== ìƒë‹¨ ì»¨íŠ¸ë¡¤ ===== */
  #topBar{
    position:fixed;top:0;left:0;right:0;z-index:20;
    background:linear-gradient(to bottom,rgba(0,0,0,.75),rgba(0,0,0,.45));
    padding:8px 12px;display:flex;flex-direction:column;gap:8px;
  }
  #topRow1{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  #topRow2{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  
  .btn{
    color:#fff;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);
    border-radius:8px;padding:6px 12px;font-size:13px;cursor:pointer;
    white-space:nowrap;user-select:none;
  }
  .btn:active{background:rgba(255,255,255,.2)}
  .btn.active{background:rgba(0,150,255,.5);border-color:rgba(0,180,255,.8)}
  .btn.green{background:rgba(46,160,67,.6);border-color:rgba(46,160,67,.9)}
  .btn.red{background:rgba(220,38,38,.6);border-color:rgba(220,38,38,.9)}
  
  .group{display:flex;align-items:center;gap:6px;color:#fff;font-size:13px}
  input[type="range"]{width:120px;height:6px}
  input[type="checkbox"]{width:16px;height:16px}
  
  /* ===== í•˜ë‹¨ ì¸ë„¤ì¼ íŠ¸ë ˆì´ ===== */
  #bottomTray{
    position:fixed;left:0;right:0;bottom:0;z-index:20;
    background:rgba(0,0,0,.75);border-top:1px solid rgba(255,255,255,.2);
    padding:8px 12px;display:flex;align-items:center;gap:8px;overflow-x:auto;
  }
  #thumbs{display:flex;gap:8px}
  .thumb{
    width:72px;height:48px;flex:0 0 auto;border-radius:6px;
    border:2px solid rgba(255,255,255,.3);overflow:hidden;cursor:pointer;
  }
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .thumb.active{border-color:#4fc3ff;box-shadow:0 0 0 2px rgba(79,195,255,.6) inset}
  
  #fileInput{display:none}
  #fileLabel{
    color:#fff;border:1px dashed rgba(255,255,255,.4);padding:6px 12px;
    border-radius:6px;cursor:pointer;font-size:13px;white-space:nowrap;
  }
  
  /* ===== ì¤‘ì•™ ë¦¬í‹°í´(ë°°ì¹˜ ê°€ì´ë“œ) ===== */
  #reticle{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    width:80px;height:80px;border:3px solid #4fc3ff;border-radius:50%;
    pointer-events:none;z-index:15;display:none;opacity:0.7;
    box-shadow:0 0 20px rgba(79,195,255,0.5);
  }
  #reticle::after{
    content:'';position:absolute;top:50%;left:50%;
    width:6px;height:6px;background:#4fc3ff;border-radius:50%;
    transform:translate(-50%,-50%);
  }
  
  /* ===== FAB ë²„íŠ¼ë“¤ (ìš°ì¸¡ í•˜ë‹¨) ===== */
  #fabContainer{
    position:fixed;right:16px;bottom:120px;z-index:21;
    display:flex;flex-direction:column;gap:12px;align-items:flex-end;
  }
  .fab{
    padding:14px 18px;border-radius:12px;font-weight:600;
    border:none;box-shadow:0 4px 16px rgba(0,0,0,.4);
    color:#fff;cursor:pointer;font-size:14px;
    min-width:100px;text-align:center;
  }
  #startBtn{background:#2ea043}
  #placeBtn{background:#0ea5e9;display:none}
  #captureBtn{background:#f59e0b;display:none}
  .fab:active{transform:scale(0.95)}
  
  /* ===== ì„ íƒëœ ê°ì²´ ì¡°ì‘ íŒ¨ë„ (ì¢Œì¸¡ í•˜ë‹¨) ===== */
  #editPanel{
    position:fixed;left:16px;bottom:120px;z-index:21;
    background:rgba(0,0,0,.85);border:1px solid rgba(255,255,255,.3);
    border-radius:12px;padding:12px;display:none;flex-direction:column;gap:10px;
    max-width:280px;
  }
  #editTitle{color:#4fc3ff;font-weight:600;font-size:14px;margin-bottom:4px}
  #editControls{display:flex;flex-direction:column;gap:8px}
  .editRow{display:flex;gap:6px;align-items:center;justify-content:space-between}
  .editLabel{color:#fff;font-size:13px;min-width:60px}
  
  /* ë°©í–¥ íŒ¨ë“œ */
  #dirPad{
    display:grid;grid-template-columns:repeat(3,36px);gap:4px;
    justify-self:center;
  }
  #dirPad button{
    width:36px;height:36px;border-radius:6px;
    border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);
    color:#fff;font-size:16px;cursor:pointer;
  }
  #dirPad button:active{background:rgba(255,255,255,.25)}
  #dirPad .center{grid-column:2;grid-row:2;font-size:11px;pointer-events:none;opacity:0.5}
  
  /* ===== í† ìŠ¤íŠ¸ ===== */
  #toast{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:12px 20px;
    border-radius:10px;z-index:50;display:none;font-size:14px;
    box-shadow:0 4px 20px rgba(0,0,0,.5);
  }
  
  /* ===== ìº¡ì²˜ ì¸ë„¤ì¼ ìŠ¤íŠ¸ë¦½ ===== */
  #captureStrip{
    position:fixed;left:12px;bottom:240px;z-index:20;
    display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow-y:auto;
  }
  #captureStrip img{
    width:80px;height:60px;border-radius:6px;
    border:1px solid rgba(255,255,255,.3);object-fit:cover;
    box-shadow:0 2px 8px rgba(0,0,0,.4);
  }
  
  /* ===== ìƒíƒœ ì¸ë””ì¼€ì´í„° ===== */
  #statusBar{
    position:fixed;top:50%;left:50%;transform:translate(-50%,60px);
    color:#fff;font-size:13px;padding:8px 16px;
    background:rgba(0,0,0,.7);border-radius:8px;
    z-index:14;display:none;
  }
</style>
</head>
<body>

<!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” -->
<div id="topBar">
  <div id="topRow1">
    <button id="btnModeWall" class="btn active">ë²½ê±¸ì´í˜•(55")</button>
    <button id="btnModeTotem" class="btn">ìŠ¤íƒ ë“œ(1900mm)</button>
    <span style="color:#666;margin:0 4px">|</span>
    <button id="btnBlack" class="btn active">ë¸”ë™</button>
    <button id="btnWhite" class="btn">í™”ì´íŠ¸</button>
    <span style="color:#666;margin:0 4px">|</span>
    <button id="clearAll" class="btn red">ì „ì²´ì‚­ì œ</button>
  </div>
  <div id="topRow2">
    <div class="group">
      <input type="checkbox" id="lockScale" checked/>
      <label for="lockScale">ì‹¤ì¸¡ ê³ ì •</label>
    </div>
    <div class="group">
      ìŠ¤ì¼€ì¼ <input id="scaleRange" type="range" min="50" max="150" value="100" disabled/>
      <span id="scaleVal">100%</span>
    </div>
    <div class="group">
      ë†’ì´ <input id="heightRange" type="range" min="-1000" max="2500" value="0"/>
      <span id="heightVal">0mm</span>
    </div>
  </div>
</div>

<!-- í•˜ë‹¨ ì¸ë„¤ì¼ íŠ¸ë ˆì´ -->
<div id="bottomTray">
  <div id="thumbs"></div>
  <label id="fileLabel" for="fileInput">ğŸ“· ì´ë¯¸ì§€ ì¶”ê°€</label>
  <input id="fileInput" type="file" accept="image/*" multiple/>
</div>

<!-- ì¤‘ì•™ ë¦¬í‹°í´ (ë°°ì¹˜ ëª¨ë“œ ì‹œ) -->
<div id="reticle"></div>
<div id="statusBar">ë°”ë‹¥ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”</div>

<!-- FAB ë²„íŠ¼ë“¤ -->
<div id="fabContainer">
  <button id="startBtn" class="fab">ğŸš€ AR ì‹œì‘</button>
  <button id="placeBtn" class="fab">ğŸ“ ë°°ì¹˜í•˜ê¸°</button>
  <button id="captureBtn" class="fab">ğŸ“¸ ìº¡ì²˜</button>
</div>

<!-- ì„ íƒëœ ê°ì²´ í¸ì§‘ íŒ¨ë„ -->
<div id="editPanel">
  <div id="editTitle">ğŸ¯ ì„ íƒëœ ëª¨ë¸ ì¡°ì‘</div>
  <div id="editControls">
    <!-- ì´ë™ íŒ¨ë“œ -->
    <div class="editRow">
      <span class="editLabel">ì´ë™</span>
      <div id="dirPad">
        <button id="padUp">â–²</button>
        <button id="padLeft">â—„</button>
        <div class="center">ì´ë™</div>
        <button id="padRight">â–º</button>
        <button id="padDown">â–¼</button>
      </div>
    </div>
    
    <!-- íšŒì „ -->
    <div class="editRow">
      <span class="editLabel">íšŒì „</span>
      <div style="display:flex;gap:8px">
        <button class="btn" id="rotLeft">âŸ² ì¢ŒíšŒì „</button>
        <button class="btn" id="rotRight">âŸ³ ìš°íšŒì „</button>
      </div>
    </div>
    
    <!-- ë†’ì´ ì¡°ì ˆ -->
    <div class="editRow">
      <span class="editLabel">ë†’ì´</span>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="heightDown">â–¼</button>
        <span id="objHeight" style="color:#fff;min-width:50px;text-align:center">0mm</span>
        <button class="btn" id="heightUp">â–²</button>
      </div>
    </div>
    
    <!-- ì‚­ì œ -->
    <div class="editRow">
      <button class="btn red" id="deleteBtn" style="flex:1">ğŸ—‘ï¸ ì‚­ì œ</button>
      <button class="btn" id="deselectBtn" style="flex:1">âœ“ ì™„ë£Œ</button>
    </div>
  </div>
</div>

<!-- ìº¡ì²˜ ì´ë¯¸ì§€ ìŠ¤íŠ¸ë¦½ -->
<div id="captureStrip"></div>

<!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
<div id="toast"></div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

/* ==================== ê¸°ë³¸ ì„¤ì • ==================== */
const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true, preserveDrawingBuffer:true});
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);

// ì¡°ëª…
scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.5));
const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
dirLight.position.set(1, 2, 1);
scene.add(dirLight);

/* ==================== ìƒíƒœ ê´€ë¦¬ ==================== */
let placedObjects = [];  // ë°°ì¹˜ëœ ëª¨ë“  ê°ì²´
let selectedObject = null; // í˜„ì¬ ì„ íƒëœ ê°ì²´
let mode = 'wall';        // 'wall' ë˜ëŠ” 'totem'
let scaleFactor = 1.0;    // ìŠ¤ì¼€ì¼ ë°°ìœ¨
let heightOffset = 0;     // mm ë‹¨ìœ„ ë†’ì´ ì˜¤í”„ì…‹
let currentScreenTexture = null; // í˜„ì¬ ì„ íƒëœ í™”ë©´ í…ìŠ¤ì²˜

let isPlacementMode = false; // ë°°ì¹˜ ëª¨ë“œ í™œì„±í™” ì—¬ë¶€
let moveStep = 0.05;         // ì´ë™ ìŠ¤í… (m)
let rotStep = 15;            // íšŒì „ ìŠ¤í… (ë„)

/* ==================== ì¬ì§ˆ ==================== */
const loader = new THREE.TextureLoader();

// ë³¸ì²´ ì¬ì§ˆ
let bodyMaterial = new THREE.MeshStandardMaterial({
  color: 0x111111,
  roughness: 0.6,
  metalness: 0.35
});

// í™”ë©´ ì¬ì§ˆ ìƒì„± í•¨ìˆ˜
function createScreenMaterial(texture) {
  return new THREE.MeshStandardMaterial({
    map: texture,
    roughness: 0.4,
    metalness: 0.1,
    emissive: 0x222222,
    emissiveIntensity: 0.3
  });
}

// ì´ˆê¸° í…ìŠ¤ì²˜ ë¡œë“œ
currentScreenTexture = loader.load('https://picsum.photos/800/450?blur=0');
currentScreenTexture.colorSpace = THREE.SRGBColorSpace;

/* ==================== ëª¨ë¸ ìƒì„± (ì‹¤ì¸¡ ê¸°ë°˜) ==================== */
function createWallModel() {
  const s = scaleFactor;
  const group = new THREE.Group();
  
  // ë³¸ì²´
  const bodyW = 1.23 * s, bodyH = 0.69 * s, bodyD = 0.05 * s;
  const body = new THREE.Mesh(
    new THREE.BoxGeometry(bodyW, bodyH, bodyD),
    bodyMaterial
  );
  body.position.y = bodyH / 2;
  group.add(body);
  
  // í™”ë©´
  const screenW = 1.205 * s, screenH = 0.678 * s;
  const screen = new THREE.Mesh(
    new THREE.PlaneGeometry(screenW, screenH),
    createScreenMaterial(currentScreenTexture)
  );
  screen.position.set(0, bodyH / 2, bodyD / 2 + 0.002);
  group.add(screen);
  
  group.userData.type = 'wall';
  group.userData.screenMesh = screen;
  group.userData.bodyMesh = body;
  
  return group;
}

function createTotemModel() {
  const s = scaleFactor;
  const group = new THREE.Group();
  
  // ë² ì´ìŠ¤
  const baseW = 0.85 * s, baseH = 0.05 * s, baseD = 0.50 * s;
  const base = new THREE.Mesh(
    new THREE.BoxGeometry(baseW, baseH, baseD),
    bodyMaterial
  );
  base.position.y = baseH / 2;
  group.add(base);
  
  // ë³¸ì²´
  const bodyW = 0.74 * s, bodyH = 1.90 * s, bodyD = 0.12 * s;
  const body = new THREE.Mesh(
    new THREE.BoxGeometry(bodyW, bodyH, bodyD),
    bodyMaterial
  );
  body.position.y = baseH + bodyH / 2;
  group.add(body);
  
  // í™”ë©´
  const screenW = bodyW * 0.88, screenH = bodyH * 0.72;
  const screen = new THREE.Mesh(
    new THREE.PlaneGeometry(screenW, screenH),
    createScreenMaterial(currentScreenTexture)
  );
  screen.position.set(0, baseH + bodyH * 0.54, bodyD / 2 + 0.002);
  group.add(screen);
  
  group.userData.type = 'totem';
  group.userData.screenMesh = screen;
  group.userData.bodyMesh = body;
  
  return group;
}

/* ==================== ë¦¬í‹°í´ (AR ë°”ë‹¥ ê°€ì´ë“œ) ==================== */
const reticleGroup = new THREE.Group();
reticleGroup.visible = false;
scene.add(reticleGroup);

const reticleFill = new THREE.Mesh(
  new THREE.CircleGeometry(0.3, 32).rotateX(-Math.PI / 2),
  new THREE.MeshBasicMaterial({ color: 0x4fc3ff, transparent: true, opacity: 0.2 })
);
const reticleRing = new THREE.Mesh(
  new THREE.RingGeometry(0.27, 0.3, 32).rotateX(-Math.PI / 2),
  new THREE.MeshBasicMaterial({ color: 0x4fc3ff, transparent: true, opacity: 0.8 })
);
reticleGroup.add(reticleFill);
reticleGroup.add(reticleRing);

/* ==================== XR Hit Test ==================== */
let hitTestSource = null;
let hitTestSourceRequested = false;
let lastHitPose = null;

function onSelectStart() {
  // XR ì»¨íŠ¸ë¡¤ëŸ¬ ì„ íƒ ì‹œ (í™”ë©´ íƒ­)
  if (isPlacementMode && lastHitPose) {
    placeModel(lastHitPose);
  }
}

renderer.xr.addEventListener('sessionstart', () => {
  console.log('XR ì„¸ì…˜ ì‹œì‘');
  $('startBtn').style.display = 'none';
  $('placeBtn').style.display = 'block';
  $('captureBtn').style.display = 'block';
  $('reticle').style.display = 'block';
  $('statusBar').style.display = 'block';
});

renderer.xr.addEventListener('sessionend', () => {
  console.log('XR ì„¸ì…˜ ì¢…ë£Œ');
  $('startBtn').style.display = 'block';
  $('placeBtn').style.display = 'none';
  $('captureBtn').style.display = 'none';
  $('reticle').style.display = 'none';
  $('statusBar').style.display = 'none';
  hitTestSourceRequested = false;
  hitTestSource = null;
  isPlacementMode = false;
});

/* ==================== ë Œë” ë£¨í”„ ==================== */
renderer.setAnimationLoop((timestamp, frame) => {
  if (frame) {
    const referenceSpace = renderer.xr.getReferenceSpace();
    const session = renderer.xr.getSession();
    
    // Hit test source ìš”ì²­
    if (!hitTestSourceRequested && session) {
      session.requestReferenceSpace('viewer').then((viewerSpace) => {
        session.requestHitTestSource({ space: viewerSpace }).then((source) => {
          hitTestSource = source;
        });
      });
      session.addEventListener('end', () => {
        hitTestSourceRequested = false;
        hitTestSource = null;
      });
      hitTestSourceRequested = true;
    }
    
    // Hit test ì‹¤í–‰
    if (hitTestSource) {
      const hitTestResults = frame.getHitTestResults(hitTestSource);
      if (hitTestResults.length > 0) {
        const hit = hitTestResults[0];
        const pose = hit.getPose(referenceSpace);
        lastHitPose = pose;
        
        // ë¦¬í‹°í´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        reticleGroup.visible = isPlacementMode;
        if (isPlacementMode) {
          const matrix = new THREE.Matrix4().fromArray(pose.transform.matrix);
          reticleGroup.position.setFromMatrixPosition(matrix);
          reticleGroup.quaternion.setFromRotationMatrix(matrix);
          $('statusBar').textContent = 'âœ“ ë°°ì¹˜ ê°€ëŠ¥ - [ë°°ì¹˜í•˜ê¸°] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”';
        }
      } else {
        reticleGroup.visible = false;
        if (isPlacementMode) {
          $('statusBar').textContent = 'ë°”ë‹¥ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”';
        }
      }
    }
  }
  
  renderer.render(scene, camera);
});

/* ==================== ëª¨ë¸ ë°°ì¹˜ ==================== */
function placeModel(pose) {
  if (!pose) return;
  
  const model = (mode === 'wall') ? createWallModel() : createTotemModel();
  
  const matrix = new THREE.Matrix4().fromArray(pose.transform.matrix);
  const position = new THREE.Vector3().setFromMatrixPosition(matrix);
  const quaternion = new THREE.Quaternion().setFromRotationMatrix(matrix);
  
  // ë†’ì´ ì˜¤í”„ì…‹ ì ìš©
  model.position.set(
    position.x,
    position.y + (heightOffset / 1000), // mm to m
    position.z
  );
  model.quaternion.copy(quaternion);
  
  // ì‚¬ìš©ì ë°ì´í„° ì €ì¥
  model.userData.groundY = position.y;
  model.userData.currentHeightOffset = heightOffset;
  
  scene.add(model);
  placedObjects.push(model);
  
  showToast('âœ“ ëª¨ë¸ì´ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤');
  
  // ë°°ì¹˜ í›„ ìë™ ì„ íƒ
  selectObject(model);
  isPlacementMode = false;
  $('placeBtn').classList.remove('active');
}

/* ==================== ê°ì²´ ì„ íƒ/í•´ì œ ==================== */
function selectObject(obj) {
  selectedObject = obj;
  $('editPanel').style.display = 'flex';
  updateEditPanel();
  
  // ì„ íƒ í‘œì‹œ (ê°„ë‹¨í•œ ì•„ì›ƒë¼ì¸ íš¨ê³¼)
  obj.traverse((child) => {
    if (child.isMesh) {
      child.userData.originalEmissive = child.material.emissive?.getHex() || 0;
      if (child.material.emissive) {
        child.material.emissive.setHex(0x4fc3ff);
        child.material.emissiveIntensity = 0.2;
      }
    }
  });
}

function deselectObject() {
  if (selectedObject) {
    // ì„ íƒ í‘œì‹œ ì œê±°
    selectedObject.traverse((child) => {
      if (child.isMesh && child.userData.originalEmissive !== undefined) {
        if (child.material.emissive) {
          child.material.emissive.setHex(child.userData.originalEmissive);
          child.material.emissiveIntensity = 0.3;
        }
      }
    });
  }
  
  selectedObject = null;
  $('editPanel').style.display = 'none';
}

function updateEditPanel() {
  if (!selectedObject) return;
  const currentHeight = selectedObject.userData.currentHeightOffset || 0;
  $('objHeight').textContent = currentHeight + 'mm';
}

/* ==================== ê°ì²´ ì¡°ì‘ í•¨ìˆ˜ ==================== */
function moveObject(dx, dz) {
  if (!selectedObject) return;
  selectedObject.position.x += dx;
  selectedObject.position.z += dz;
}

function rotateObject(angleDeg) {
  if (!selectedObject) return;
  selectedObject.rotation.y += THREE.MathUtils.degToRad(angleDeg);
}

function adjustHeight(deltaY) {
  if (!selectedObject) return;
  const newOffset = (selectedObject.userData.currentHeightOffset || 0) + deltaY;
  selectedObject.userData.currentHeightOffset = newOffset;
  const groundY = selectedObject.userData.groundY || selectedObject.position.y;
  selectedObject.position.y = groundY + (newOffset / 1000);
  updateEditPanel();
}

function deleteObject() {
  if (!selectedObject) return;
  scene.remove(selectedObject);
  const index = placedObjects.indexOf(selectedObject);
  if (index > -1) placedObjects.splice(index, 1);
  showToast('ğŸ—‘ï¸ ëª¨ë¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  deselectObject();
}

/* ==================== UI í—¬í¼ ==================== */
const $ = (id) => document.getElementById(id);

function showToast(message, duration = 2000) {
  const toast = $('toast');
  toast.textContent = message;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, duration);
}

function setActive(btnId, group) {
  group.forEach(id => $(id).classList.remove('active'));
  $(btnId).classList.add('active');
}

/* ==================== ì¸ë„¤ì¼ ê´€ë¦¬ ==================== */
function addThumbnail(url, isDefault = false) {
  const thumb = document.createElement('div');
  thumb.className = 'thumb';
  if (isDefault) thumb.classList.add('active');
  
  const img = document.createElement('img');
  img.src = url;
  thumb.appendChild(img);
  
  thumb.onclick = () => {
    document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
    thumb.classList.add('active');
    
    // ìƒˆ í…ìŠ¤ì²˜ ë¡œë“œ
    const newTexture = loader.load(url);
    newTexture.colorSpace = THREE.SRGBColorSpace;
    currentScreenTexture = newTexture;
    
    // ì„ íƒëœ ê°ì²´ê°€ ìˆìœ¼ë©´ ì¦‰ì‹œ ì ìš©
    if (selectedObject && selectedObject.userData.screenMesh) {
      selectedObject.userData.screenMesh.material = createScreenMaterial(newTexture);
    }
    
    showToast('ğŸ“º í™”ë©´ ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
  };
  
  $('thumbs').appendChild(thumb);
}

// ê¸°ë³¸ ì¸ë„¤ì¼ ì¶”ê°€
addThumbnail('https://picsum.photos/800/450?random=1', true);
addThumbnail('https://picsum.photos/800/450?random=2');
addThumbnail('https://picsum.photos/800/450?random=3');

/* ==================== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ==================== */

// ëª¨ë“œ ì„ íƒ
$('btnModeWall').onclick = () => {
  mode = 'wall';
  setActive('btnModeWall', ['btnModeWall', 'btnModeTotem']);
};

$('btnModeTotem').onclick = () => {
  mode = 'totem';
  setActive('btnModeTotem', ['btnModeWall', 'btnModeTotem']);
};

// ìƒ‰ìƒ ì„ íƒ
$('btnBlack').onclick = () => {
  bodyMaterial.color.setHex(0x111111);
  setActive('btnBlack', ['btnBlack', 'btnWhite']);
};

$('btnWhite').onclick = () => {
  bodyMaterial.color.setHex(0xf2f2f2);
  setActive('btnWhite', ['btnBlack', 'btnWhite']);
};

// ìŠ¤ì¼€ì¼ ì ê¸ˆ
$('lockScale').onchange = () => {
  const locked = $('lockScale').checked;
  $('scaleRange').disabled = locked;
  if (locked) {
    scaleFactor = 1.0;
    $('scaleRange').value = 100;
    $('scaleVal').textContent = '100%';
  }
};

$('scaleRange').oninput = () => {
  const val = parseInt($('scaleRange').value);
  scaleFactor = val / 100;
  $('scaleVal').textContent = val + '%';
};

// ë†’ì´ ì˜¤í”„ì…‹
$('heightRange').oninput = () => {
  heightOffset = parseInt($('heightRange').value);
  $('heightVal').textContent = heightOffset + 'mm';
};

// ì „ì²´ ì‚­ì œ
$('clearAll').onclick = () => {
  if (placedObjects.length === 0) {
    showToast('âš ï¸ ì‚­ì œí•  ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  if (confirm(`${placedObjects.length}ê°œì˜ ëª¨ë¸ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    placedObjects.forEach(obj => scene.remove(obj));
    placedObjects = [];
    deselectObject();
    showToast('ğŸ—‘ï¸ ëª¨ë“  ëª¨ë¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
  }
};

// íŒŒì¼ ì—…ë¡œë“œ
$('fileInput').onchange = (e) => {
  const files = Array.from(e.target.files || []);
  files.forEach((file, index) => {
    const url = URL.createObjectURL(file);
    addThumbnail(url, index === 0);
  });
  if (files.length > 0) {
    showToast(`ğŸ“· ${files.length}ê°œì˜ ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
  }
};

// AR ì‹œì‘
let arButton = null;
$('startBtn').onclick = () => {
  if (!('xr' in navigator)) {
    alert('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” WebXRì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nARì„ ì‚¬ìš©í•˜ë ¤ë©´ AR Coreë¥¼ ì§€ì›í•˜ëŠ” Android ê¸°ê¸°ì—ì„œ\nChrome ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!arButton) {
    arButton = ARButton.createButton(renderer, {
      requiredFeatures: ['hit-test'],
      optionalFeatures: ['dom-overlay'],
      domOverlay: { root: document.body }
    });
    arButton.style.display = 'none';
    document.body.appendChild(arButton);
  }
  
  arButton.click();
};

// ë°°ì¹˜ ëª¨ë“œ í† ê¸€
$('placeBtn').onclick = () => {
  isPlacementMode = !isPlacementMode;
  $('placeBtn').classList.toggle('active', isPlacementMode);
  
  if (isPlacementMode) {
    $('placeBtn').textContent = 'âœ“ ë°°ì¹˜ ì¤€ë¹„';
    showToast('ğŸ’¡ ë°”ë‹¥ì„ í–¥í•´ ê¸°ê¸°ë¥¼ ì›€ì§ì´ê³ \n[ë°°ì¹˜í•˜ê¸°] ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆ„ë¥´ì„¸ìš”');
    deselectObject(); // ë°°ì¹˜ ëª¨ë“œ ì‹œ ì„ íƒ í•´ì œ
  } else {
    $('placeBtn').textContent = 'ğŸ“ ë°°ì¹˜í•˜ê¸°';
    
    // ë°°ì¹˜ ëª¨ë“œ ì¢…ë£Œ ì‹œ ëª¨ë¸ ë°°ì¹˜
    if (lastHitPose) {
      placeModel(lastHitPose);
    }
  }
};

// ìº¡ì²˜
$('captureBtn').onclick = async () => {
  if (placedObjects.length === 0) {
    showToast('âš ï¸ ë°°ì¹˜ëœ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤');
    return;
  }
  
  // UI ìˆ¨ê¸°ê¸°
  const uiElements = ['topBar', 'bottomTray', 'fabContainer', 'editPanel', 'reticle', 'statusBar', 'captureStrip'];
  uiElements.forEach(id => {
    const el = $(id);
    if (el) el.style.visibility = 'hidden';
  });
  
  await new Promise(requestAnimationFrame);
  
  try {
    const dataUrl = renderer.domElement.toDataURL('image/png');
    
    // ë‹¤ìš´ë¡œë“œ
    const a = document.createElement('a');
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    a.href = dataUrl;
    a.download = `DID_AR_${timestamp}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    
    // ìº¡ì²˜ ì¸ë„¤ì¼ ì¶”ê°€
    const img = document.createElement('img');
    img.src = dataUrl;
    $('captureStrip').prepend(img);
    
    // ê³µìœ  ì‹œë„ (ëª¨ë°”ì¼)
    if (navigator.canShare) {
      const response = await fetch(dataUrl);
      const blob = await response.blob();
      const file = new File([blob], `DID_AR_${timestamp}.png`, { type: 'image/png' });
      
      if (navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: 'DID AR Capture'
          });
        } catch (err) {
          console.log('ê³µìœ  ì·¨ì†Œ ë˜ëŠ” ì‹¤íŒ¨:', err);
        }
      }
    }
    
    showToast('ğŸ“¸ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
  } catch (err) {
    showToast('âŒ ìº¡ì²˜ ì‹¤íŒ¨: ' + err.message);
  } finally {
    // UI ë‹¤ì‹œ í‘œì‹œ
    uiElements.forEach(id => {
      const el = $(id);
      if (el) el.style.visibility = 'visible';
    });
  }
};

// í¸ì§‘ íŒ¨ë„ - ì´ë™
function setupMoveButton(btnId, dx, dz) {
  let interval = null;
  const btn = $(btnId);
  
  const move = () => moveObject(dx * moveStep, dz * moveStep);
  
  const start = () => {
    move();
    interval = setInterval(move, 150);
  };
  
  const stop = () => {
    if (interval) {
      clearInterval(interval);
      interval = null;
    }
  };
  
  btn.addEventListener('touchstart', start, { passive: true });
  btn.addEventListener('mousedown', start);
  btn.addEventListener('touchend', stop);
  btn.addEventListener('touchcancel', stop);
  btn.addEventListener('mouseup', stop);
  btn.addEventListener('mouseleave', stop);
}

setupMoveButton('padUp', 0, -1);
setupMoveButton('padDown', 0, 1);
setupMoveButton('padLeft', -1, 0);
setupMoveButton('padRight', 1, 0);

// í¸ì§‘ íŒ¨ë„ - íšŒì „
$('rotLeft').onclick = () => rotateObject(-rotStep);
$('rotRight').onclick = () => rotateObject(rotStep);

// í¸ì§‘ íŒ¨ë„ - ë†’ì´
$('heightUp').onclick = () => adjustHeight(50);
$('heightDown').onclick = () => adjustHeight(-50);

// í¸ì§‘ íŒ¨ë„ - ì‚­ì œ/ì™„ë£Œ
$('deleteBtn').onclick = deleteObject;
$('deselectBtn').onclick = deselectObject;

/* ==================== í„°ì¹˜ ì œìŠ¤ì²˜ (í™”ë©´ íƒ­ìœ¼ë¡œ ì„ íƒ) ==================== */
const raycaster = new THREE.Raycaster();
let touchStartTime = 0;
let touchStartPos = { x: 0, y: 0 };

renderer.domElement.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1 && !isPlacementMode) {
    touchStartTime = Date.now();
    touchStartPos.x = e.touches[0].clientX;
    touchStartPos.y = e.touches[0].clientY;
  }
}, { passive: true });

renderer.domElement.addEventListener('touchend', (e) => {
  if (e.changedTouches.length === 1 && !isPlacementMode) {
    const touchEndTime = Date.now();
    const touchEndPos = {
      x: e.changedTouches[0].clientX,
      y: e.changedTouches[0].clientY
    };
    
    const timeDiff = touchEndTime - touchStartTime;
    const distance = Math.hypot(
      touchEndPos.x - touchStartPos.x,
      touchEndPos.y - touchStartPos.y
    );
    
    // íƒ­ìœ¼ë¡œ ì¸ì‹ (ì§§ì€ ì‹œê°„, ì§§ì€ ê±°ë¦¬)
    if (timeDiff < 300 && distance < 20) {
      trySelectObject(touchEndPos.x, touchEndPos.y);
    }
  }
});

function trySelectObject(clientX, clientY) {
  if (placedObjects.length === 0) return;
  
  const x = (clientX / window.innerWidth) * 2 - 1;
  const y = -(clientY / window.innerHeight) * 2 + 1;
  
  raycaster.setFromCamera({ x, y }, camera);
  
  const meshes = [];
  placedObjects.forEach(obj => {
    obj.traverse(child => {
      if (child.isMesh) meshes.push(child);
    });
  });
  
  const intersects = raycaster.intersectObjects(meshes, false);
  
  if (intersects.length > 0) {
    let target = intersects[0].object;
    
    // ë¶€ëª¨ ê·¸ë£¹ ì°¾ê¸°
    while (target && !placedObjects.includes(target)) {
      target = target.parent;
    }
    
    if (target) {
      if (selectedObject === target) {
        deselectObject(); // ë‹¤ì‹œ íƒ­í•˜ë©´ ì„ íƒ í•´ì œ
      } else {
        deselectObject();
        selectObject(target);
        showToast('âœ“ ëª¨ë¸ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤');
      }
    }
  } else {
    deselectObject();
  }
}

/* ==================== ë¦¬ì‚¬ì´ì¦ˆ ==================== */
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

console.log('âœ… DID AR Enhanced ì´ˆê¸°í™” ì™„ë£Œ');
</script>
</body>
</html>
